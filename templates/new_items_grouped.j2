{#
  ModÃ¨le d'Ã©lÃ©ments groupÃ©s nouveaux pour Jellynouncer
  ====================================================

  Notification groupÃ©e complÃ¨te organisant les Ã©lÃ©ments par type.
  Affiche tous les nouveaux Ã©lÃ©ments dans des sections catÃ©gorisÃ©es avec mÃ©tadonnÃ©es.

  Prend en charge : Films, TV, Musique, Autres
  Limites Discord : Un seul embed avec plusieurs champs de catÃ©gorie
#}
{
  "embeds": [
    {
      "title": {{ ("ðŸ†• " ~ (total_items | string) ~ " Nouveaux Ã©lÃ©ments ajoutÃ©s Ã  Jellyfin") | tojson }},

      "description": "Un rÃ©sumÃ© de tout le nouveau contenu organisÃ© par type :",

      "color": 65280,

      "fields": [
        {% set field_count = namespace(value=0) %}

        {#
          CatÃ©gorie Films
          ---------------
        #}
        {% if 'movies' in categories and categories.movies.new|length > 0 %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "ðŸŽ¬ Films ({{ categories.movies.new|length }})",
          "value": {{ (
            {%- for item_data in categories.movies.new[:5] -%}
              "**" ~ item_data.item.name ~ "**" ~
              (" (" ~ item_data.item.year ~ ")" if item_data.item.year else "") ~
              (" â€¢ " ~ item_data.item.video_height ~ "p" if item_data.item.video_height else "") ~
              {%- set rating_parts = [] -%}
              {%- if item_data.item.omdb and item_data.item.omdb.imdb_rating and item_data.item.omdb.imdb_rating != 'N/A' -%}
                {%- set _ = rating_parts.append('IMDb: ' ~ item_data.item.omdb.imdb_rating) -%}
              {%- endif -%}
              {%- if item_data.item.tmdb and item_data.item.tmdb.rating_display -%}
                {%- set _ = rating_parts.append('TMDb: ' ~ item_data.item.tmdb.rating_display ~ '/10') -%}
              {%- endif -%}
              ("\nâ­ " ~ (rating_parts | join(' â€¢ ')) if rating_parts|length > 0 else "") ~
              ("\n" if not loop.last else "")
            {%- endfor -%}
            {%- if categories.movies.new|length > 5 %}\n...et {{ categories.movies.new|length - 5 }} de plus{% endif %}
          ) | tojson }},
          "inline": false
        }
        {% endif %}

        {#
          CatÃ©gorie TV
          ------------
        #}
        {% if 'tv' in categories and categories.tv.new|length > 0 %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "ðŸ“º Contenu TV ({{ categories.tv.new|length }})",
          "value": {{ (
            {%- for item_data in categories.tv.new[:5] -%}
              {%- if item_data.item.item_type == 'Episode' -%}
                \"**\" ~ item_data.item.series_name ~ \"** S\" ~ ('%02d'|format(item_data.item.season_number or 0)) ~ \"E\" ~ ('%02d'|format(item_data.item.episode_number or 0))
              {%- else -%}
                \"**\" ~ item_data.item.name ~ \"**\"
              {%- endif %} ~
              (\" â€¢ \" ~ item_data.item.video_height ~ \"p\" if item_data.item.video_height else \"\") ~
              (\"\\nâ­ TVDb: \" ~ item_data.item.tvdb.rating if item_data.item.tvdb and item_data.item.tvdb.rating else \"\") ~
              (\"\\n\" if not loop.last else \"\")
            {%- endfor -%}
            {%- if categories.tv.new|length > 5 %}\\n...et {{ categories.tv.new|length - 5 }} de plus{% endif %}
          ) | tojson }},
          "inline": false
        }
        {% endif %}

        {#
          CatÃ©gorie Musique
          -----------------
        #}
        {% if 'music' in categories and categories.music.new|length > 0 %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "ðŸŽµ Musique ({{ categories.music.new|length }})",
          "value": {{ (
            {%- for item_data in categories.music.new[:6] -%}
              {%- if item_data.item.item_type == 'Audio' -%}
                \"ðŸŽµ **\" ~ item_data.item.name ~ \"**\" ~
                (\" - \" ~ item_data.item.artists[0] if item_data.item.artists else \"\")
              {%- elif item_data.item.item_type == 'MusicAlbum' -%}
                \"ðŸ’¿ **\" ~ item_data.item.name ~ \"**\" ~
                (\" - \" ~ item_data.item.album_artist if item_data.item.album_artist else \"\")
              {%- else -%}
                \"**\" ~ item_data.item.name ~ \"**\"
              {%- endif %} ~
              (\"\\n\" if not loop.last else \"\")
            {%- endfor -%}
            {%- if categories.music.new|length > 6 %}\\n...et {{ categories.music.new|length - 6 }} de plus{% endif %}
          ) | tojson }},
          "inline": false
        }
        {% endif %}

        {#
          CatÃ©gorie Autres
          ----------------
        #}
        {% if 'other' in categories and categories.other.new|length > 0 %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "ðŸ“ Autres ({{ categories.other.new|length }})",
          "value": {{ (
            {%- for item_data in categories.other.new[:6] -%}
              "**" ~ item_data.item.name ~ "** (" ~ item_data.item.item_type ~ ")" ~
              ("\n" if not loop.last else "")
            {%- endfor -%}
            {%- if categories.other.new|length > 6 %}\n...et {{ categories.other.new|length - 6 }} de plus{% endif %}
          ) | tojson }},
          "inline": false
        }
        {% endif %}

        {#
          Statistiques rÃ©sumÃ©
          -------------------
        #}
        {% if field_count.value > 0 %},{% endif %}
        {
          "name": "ðŸ“Š RÃ©sumÃ©",
          "value": {{ ("**Total des Ã©lÃ©ments :** " ~ total_items ~
            ("\nðŸŽ¬ Films : " ~ categories.movies.new|length if 'movies' in categories else "") ~
            ("\nðŸ“º TV : " ~ categories.tv.new|length if 'tv' in categories else "") ~
            ("\nðŸŽµ Musique : " ~ categories.music.new|length if 'music' in categories else "") ~
            ("\nðŸ“ Autres : " ~ categories.other.new|length if 'other' in categories else "")
          ) | tojson }},
          "inline": false
        }
      ],

      "footer": {
        "text": {{ ("Jellyfin" ~
          (" â€¢ " ~ new_items[0].item.server_name if new_items and new_items[0].item.server_name else "") ~
          {%- set has_omdb = new_items | selectattr('item.omdb') | list | length > 0 if new_items else false -%}
          {%- set has_tvdb = new_items | selectattr('item.tvdb') | list | length > 0 if new_items else false -%}
          {%- set has_tmdb = new_items | selectattr('item.tmdb') | list | length > 0 if new_items else false -%}
          (" â€¢ IMDb via OMDb" if has_omdb else "") ~
          (" â€¢ TheTVDB" if has_tvdb else "") ~
          (" â€¢ TMDb" if has_tmdb else "")
        ) | tojson }},
        "icon_url": {{ (jellyfin_url ~ "/web/favicon.png") | tojson }}
      },

      "timestamp": {{ timestamp | tojson }}
    }
  ]
}
