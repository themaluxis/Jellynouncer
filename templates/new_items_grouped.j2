{#
  New Items Grouped Template for Jellynouncer
  ============================================

  Comprehensive grouped notification organizing items by type.
  Shows all new items in categorized sections with metadata.

  Supports: Movies, TV, Music, Other
  Discord limits: Single embed with multiple category fields
#}
{
  "embeds": [
    {
      "title": "ðŸ†• {{ total_items }} New Items Added to Jellyfin",

      "description": "A summary of all newly added content organized by type:",

      "color": 65280,

      "fields": [
        {% set field_count = namespace(value=0) %}

        {#
          Movies Category
          ---------------
        #}
        {% if 'movies' in categories and categories.movies.new|length > 0 %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "ðŸŽ¬ Movies ({{ categories.movies.new|length }})",
          "value": "{% for item_data in categories.movies.new[:5] -%}
            **{{ item_data.item.name }}**
            {%- if item_data.item.year %} ({{ item_data.item.year }}){% endif %}
            {%- if item_data.item.video_height %} â€¢ {{ item_data.item.video_height }}p{% endif -%}
            {%- set rating_parts = [] -%}
            {%- if item_data.item.omdb and item_data.item.omdb.imdb_rating and item_data.item.omdb.imdb_rating != 'N/A' -%}
              {%- set _ = rating_parts.append('IMDb: ' ~ item_data.item.omdb.imdb_rating) -%}
            {%- endif -%}
            {%- if item_data.item.tmdb and item_data.item.tmdb.vote_average -%}
              {%- set _ = rating_parts.append('TMDb: ' ~ item_data.item.tmdb.vote_average) -%}
            {%- endif -%}
            {%- if rating_parts|length > 0 %}\nâ­ {{ rating_parts | join(' â€¢ ') }}{% endif -%}
            {%- if not loop.last %}\n{% endif -%}
          {%- endfor -%}
          {%- if categories.movies.new|length > 5 %}\n...and {{ categories.movies.new|length - 5 }} more{% endif %}",
          "inline": false
        }
        {% endif %}

        {#
          TV Category
          -----------
        #}
        {% if 'tv' in categories and categories.tv.new|length > 0 %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "ðŸ“º TV Content ({{ categories.tv.new|length }})",
          "value": "{% for item_data in categories.tv.new[:5] -%}
            {%- if item_data.item.item_type == 'Episode' -%}
              **{{ item_data.item.series_name }}** S{{ '%02d'|format(item_data.item.season_number or 0) }}E{{ '%02d'|format(item_data.item.episode_number or 0) }}
            {%- else -%}
              **{{ item_data.item.name }}**
            {%- endif %}
            {%- if item_data.item.video_height %} â€¢ {{ item_data.item.video_height }}p{% endif -%}
            {%- if item_data.item.tvdb and item_data.item.tvdb.rating %}\nâ­ TVDb: {{ item_data.item.tvdb.rating }}{% endif -%}
            {%- if not loop.last %}\n{% endif -%}
          {%- endfor -%}
          {%- if categories.tv.new|length > 5 %}\n...and {{ categories.tv.new|length - 5 }} more{% endif %}",
          "inline": false
        }
        {% endif %}

        {#
          Music Category
          --------------
        #}
        {% if 'music' in categories and categories.music.new|length > 0 %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "ðŸŽµ Music ({{ categories.music.new|length }})",
          "value": "{% for item_data in categories.music.new[:6] -%}
            {%- if item_data.item.item_type == 'Audio' -%}
              ðŸŽµ **{{ item_data.item.name }}**
              {%- if item_data.item.artists %} - {{ item_data.item.artists[0] }}{% endif -%}
            {%- elif item_data.item.item_type == 'MusicAlbum' -%}
              ðŸ’¿ **{{ item_data.item.name }}**
              {%- if item_data.item.album_artist %} - {{ item_data.item.album_artist }}{% endif -%}
            {%- else -%}
              **{{ item_data.item.name }}**
            {%- endif -%}
            {%- if not loop.last %}\n{% endif -%}
          {%- endfor -%}
          {%- if categories.music.new|length > 6 %}\n...and {{ categories.music.new|length - 6 }} more{% endif %}",
          "inline": false
        }
        {% endif %}

        {#
          Other Category
          --------------
        #}
        {% if 'other' in categories and categories.other.new|length > 0 %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "ðŸ“ Other ({{ categories.other.new|length }})",
          "value": "{% for item_data in categories.other.new[:6] -%}
            **{{ item_data.item.name }}** ({{ item_data.item.item_type }})
            {%- if not loop.last %}\n{% endif -%}
          {%- endfor -%}
          {%- if categories.other.new|length > 6 %}\n...and {{ categories.other.new|length - 6 }} more{% endif %}",
          "inline": false
        }
        {% endif %}

        {#
          Summary Statistics
          ------------------
        #}
        {% if field_count.value > 0 %},{% endif %}
        {
          "name": "ðŸ“Š Summary",
          "value": "**Total Items:** {{ total_items }}
            {%- if 'movies' in categories %}\nðŸŽ¬ Movies: {{ categories.movies.new|length }}{% endif -%}
            {%- if 'tv' in categories %}\nðŸ“º TV: {{ categories.tv.new|length }}{% endif -%}
            {%- if 'music' in categories %}\nðŸŽµ Music: {{ categories.music.new|length }}{% endif -%}
            {%- if 'other' in categories %}\nðŸ“ Other: {{ categories.other.new|length }}{% endif %}",
          "inline": false
        }
      ],

      "footer": {
        "text": "Jellyfin
          {%- if new_items and new_items[0].item.server_name %} â€¢ {{ new_items[0].item.server_name }}{% endif %}
          {%- set has_omdb = new_items | selectattr('item.omdb') | list | length > 0 if new_items else false -%}
          {%- set has_tvdb = new_items | selectattr('item.tvdb') | list | length > 0 if new_items else false -%}
          {%- set has_tmdb = new_items | selectattr('item.tmdb') | list | length > 0 if new_items else false -%}
          {%- if has_omdb %} â€¢ IMDb via OMDb{% endif -%}
          {%- if has_tvdb %} â€¢ TheTVDB{% endif -%}
          {%- if has_tmdb %} â€¢ TMDb{% endif %}",
        "icon_url": "{{ jellyfin_url }}/web/favicon.png"
      },

      "timestamp": "{{ timestamp }}"
    }
  ]
}