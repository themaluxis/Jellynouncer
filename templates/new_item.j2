{#
  Modèle Jinja2 Discord Webhook pour nouveaux éléments - Jellynouncer
  ====================================================================

  Ce modèle génère des messages Discord intégrés pour les nouveaux éléments multimédias.
  Il utilise intelligemment les métadonnées de sources multiples avec des solutions de repli.

  Priorité des sources de métadonnées :
  ------------------------------------
  - Séries TV/Épisodes : TVDb → propriétés de base Jellyfin
  - Films : TMDb → OMDb → propriétés de base Jellyfin
  - Musique : propriétés de base Jellyfin uniquement

  Limites Discord respectées :
  ----------------------------
  - Max 256 caractères pour le titre
  - Max 4096 caractères pour la description
  - Max 25 champs (nous utilisons ~10-15)
  - Max 1024 caractères par valeur de champ
  - Max 6000 caractères total par embed
#}
{
  "embeds": [
    {
      {#
        Titre dynamique basé sur le type d'élément
        -------------------------------------------
        Affiche l'emoji et le libellé appropriés pour chaque catégorie de média
      #}
      "title": {% if item.item_type == 'Episode' -%}
        {{ ("🆕📺 " ~ ((item.series_name | default('Série inconnue')) ~ " " ~ "S" ~ ("%02d" % (item.season_number | default(0))) ~ "E" ~ ("%02d" % (item.episode_number | default(0))) | truncate(200, True, '...'))) | tojson }}
      {%- elif item.item_type == 'Series' -%}
        {{ ("🆕📺 " ~ (item.name | default('Série inconnue') | truncate(200, True, '...'))) | tojson }}
      {%- elif item.item_type == 'Movie' -%}
        {{ ("🆕🎬 " ~ (item.name | default('Film inconnu') | truncate(200, True, '...'))) | tojson }}
      {%- elif item.item_type == 'Season' -%}
        {{ ("🆕📺 " ~ (item.series_name | default('Série inconnue')) ~ " - Saison " ~ (item.season_number | default('?'))) | tojson }}
      {%- elif item.item_type == 'Audio' -%}
        {{ ("🆕🎵 " ~ (item.name | default('Chanson inconnue') | truncate(200, True, '...'))) | tojson }}
      {%- elif item.item_type == 'MusicAlbum' -%}
        {{ ("🆕💿 " ~ (item.name | default('Album inconnu') | truncate(200, True, '...'))) | tojson }}
      {%- elif item.item_type == 'MusicArtist' -%}
        {{ ("🆕🎤 " ~ (item.name | default('Artiste inconnu') | truncate(200, True, '...'))) | tojson }}
      {%- elif item.item_type == 'Photo' -%}
        {{ ("🆕📷 " ~ (item.name | default('Nouvelle photo') | truncate(200, True, '...'))) | tojson }}
      {%- else -%}
        {{ ("🆕📁 " ~ (item.name | default('Inconnu ' ~ item.item_type) | truncate(200, True, '...'))) | tojson }}
      {%- endif %},

      {#
        Description riche avec priorité des métadonnées
        ------------------------------------------------
        TV : Résumé TVDb → Résumé Jellyfin
        Films : Résumé TMDb → Intrigue OMDb → Résumé Jellyfin
        Musique : Infos artiste/album de Jellyfin
      #}
      "description": {% if item.item_type == 'Episode' -%}
        {{ ("**" ~ (item.name | default('Épisode inconnu')) ~ "**" ~
        ("\n\n" ~ "📝 Résumé" ~ "\n" ~ ((item.tvdb.overview[:400] ~ '...') if item.tvdb.overview | length > 400 else item.tvdb.overview) if item.tvdb and item.tvdb.overview and item.tvdb.overview | length > 0 else
         "\n\n" ~ ((item.overview[:400] ~ '...') if item.overview | length > 400 else item.overview) if item.overview and item.overview | length > 0 else
         "")) | tojson }}
      {%- elif item.item_type in ['Series', 'Season'] -%}
        {{ ("**" ~ (item.name | default('Titre inconnu')) ~ "**" ~
        (" (" ~ item.year ~ ")" if item.year else "") ~
        ("\n\n" ~ ((item.tvdb.overview[:400] ~ '...') if item.tvdb.overview | length > 400 else item.tvdb.overview) if item.tvdb and item.tvdb.overview and item.tvdb.overview | length > 0 else
         "\n\n" ~ ((item.overview[:400] ~ '...') if item.overview | length > 400 else item.overview) if item.overview and item.overview | length > 0 else
         "")) | tojson }}
      {%- elif item.item_type == 'Movie' -%}
        {{ ("**" ~ (item.name | default('Titre inconnu')) ~ "**" ~
        (" (" ~ item.year ~ ")" if item.year else "") ~
        ("\n\n" ~ ((item.tmdb.overview[:400] ~ '...') if item.tmdb.overview | length > 400 else item.tmdb.overview) if item.tmdb and item.tmdb.overview and item.tmdb.overview | length > 0 else
         "\n\n" ~ ((item.omdb.plot[:400] ~ '...') if item.omdb.plot | length > 400 else item.omdb.plot) if item.omdb and item.omdb.plot and item.omdb.plot != 'N/A' else
         "\n\n" ~ ((item.overview[:400] ~ '...') if item.overview | length > 400 else item.overview) if item.overview and item.overview | length > 0 else
         "")) | tojson }}
      {%- elif item.item_type == 'Audio' -%}
        {{ ("**" ~ (item.name | default('Chanson inconnue')) ~ "**" ~
        (" par " ~ (item.artists | join(', ')) if item.artists is defined and item.artists and item.artists | length > 0 else
         " par " ~ item.album_artist if item.album_artist is defined and item.album_artist else
         "") ~
        (" de **" ~ item.album ~ "**" if item.album is defined and item.album else
         "")) | tojson }}
      {%- elif item.item_type == 'MusicAlbum' -%}
        {{ ("**" ~ (item.name | default('Album inconnu')) ~ "**" ~
        (" par " ~ item.album_artist if item.album_artist is defined and item.album_artist else
         " par " ~ (item.artists | join(', ')) if item.artists is defined and item.artists and item.artists | length > 0 else
         "")) | tojson }}
      {%- else -%}
        {{ ("**" ~ (item.name | default('Titre inconnu')) ~ "**" ~
        ("\n\n" ~ ((item.overview[:400] ~ '...') if item.overview | length > 400 else item.overview) if item.overview and item.overview | length > 0 else
         "")) | tojson }}
      {%- endif %},

      "color": {{ color }},

      {#
        Système de champs intelligent avec métadonnées
        -----------------------------------------------
        Suit le nombre de champs pour rester sous la limite de 25 champs de Discord
        Affiche uniquement les champs essentiels pour le modèle standard
      #}
      "fields": [
        {%- set fields_added = namespace(count=0) -%}

        {#
          Ligne des spécifications techniques
          ------------------------------------
          Qualité vidéo, codec et informations audio
        #}
        {% if item.video_height and item.item_type not in ['Audio', 'MusicAlbum', 'MusicArtist'] -%}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "📐 Qualité :",
          "value": {{ (item.video_height ~ "p" ~
            (" " ~ item.video_range if item.video_range and item.video_range != 'SDR' else "")) | tojson }},
          "inline": true
        }
        {%- endif %}

        {% if item.video_codec and item.item_type not in ['Audio', 'MusicAlbum', 'MusicArtist'] -%}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "🎞️ Vidéo :",
          "value": {{ ((item.video_codec | upper) ~
            (" " ~ item.video_profile if item.video_profile else "")) | tojson }},
          "inline": true
        }
        {%- endif %}

        {% if item.audio_codec -%}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "🔊 Audio :",
          "value": {{ ((item.audio_codec | upper) ~
            (" Stéréo" if item.audio_channels == 2 else
             " 5.1" if item.audio_channels == 6 else
             " 7.1" if item.audio_channels == 8 else
             " " ~ item.audio_channels ~ "ch" if item.audio_channels else "")) | tojson }},
          "inline": true
        }
        {%- endif %}

        {#
          Ligne d'informations de contenu
          --------------------------------
          Durée, genres et taille de fichier avec solutions de repli métadonnées
        #}
        {% if item.runtime_ticks or (item.omdb and item.omdb.runtime_minutes) -%}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "⏱️ Durée :",
          "value": {% if item.runtime_ticks -%}
              {%- set minutes = (item.runtime_ticks / 600000000) | int -%}
              {%- set hours = (minutes / 60) | int -%}
              {%- set mins = (minutes % 60) -%}
              {{ (hours ~ "h " ~ mins ~ "m" if hours > 0 else mins ~ " min") | tojson }}
            {%- elif item.omdb and item.omdb.runtime_minutes -%}
              {%- set hours = (item.omdb.runtime_minutes / 60) | int -%}
              {%- set mins = (item.omdb.runtime_minutes % 60) -%}
              {{ (hours ~ "h " ~ mins ~ "m" if hours > 0 else mins ~ " min") | tojson }}
            {%- else -%}
              "N/A"
            {%- endif %},
          "inline": true
        }
        {%- endif %}

        {#
          Informations de genre avec priorité de source
          ----------------------------------------------
          TV : Genres TVDb → Genres Jellyfin
          Films : Genres TMDb → Genres OMDb → Genres Jellyfin
        #}
        {% set display_genres = null %}
        {% if item.item_type in ['Series', 'Season', 'Episode'] %}
          {% if item.tvdb and item.tvdb.genres and item.tvdb.genres | length > 0 %}
            {% set display_genres = item.tvdb.genres %}
          {% elif item.genres and item.genres | length > 0 %}
            {% set display_genres = item.genres %}
          {% endif %}
        {% elif item.item_type == 'Movie' %}
          {% if item.tmdb and item.tmdb.genres_list and item.tmdb.genres_list | length > 0 %}
            {% set display_genres = item.tmdb.genres_list %}
          {% elif item.omdb and item.omdb.genres_list and item.omdb.genres_list | length > 0 %}
            {% set display_genres = item.omdb.genres_list %}
          {% elif item.genres and item.genres | length > 0 %}
            {% set display_genres = item.genres %}
          {% endif %}
        {% elif item.genres and item.genres | length > 0 %}
          {% set display_genres = item.genres %}
        {% endif %}

        {% if display_genres and display_genres | length > 0 -%}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "🎭 Genres :",
          "value": {{ ((display_genres[:3] | join(', ')) ~
            (" +" ~ (display_genres | length - 3) if display_genres | length > 3 else "")) | tojson }},
          "inline": true
        }
        {%- endif %}

        {% if item.file_size -%}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "💾 Taille :",
          "value": {{ (("%.1f" % (item.file_size / 1073741824)) ~ " GB") | tojson }},
          "inline": true
        }
        {%- endif %}

        {#
          Champ de notes complet - Affichage en ligne
          --------------------------------------------
          Affiche toutes les notes disponibles de toutes les sources sur une seule ligne
          Format : IMDb: 8.5 • RT: 94% • MC: 84 • TMDb: 8.3 • TVDb: 9.2
        #}
        {% set has_ratings = false %}
        {% if (item.omdb and (item.omdb.imdb_rating or item.omdb.metascore or
               item.omdb.ratings_dict.rotten_tomatoes)) or
               (item.tmdb and item.tmdb.rating_display) or
               (item.tvdb and item.tvdb.rating) %}
          {% set has_ratings = true %}
        {% endif %}

        {% if has_ratings and fields_added.count < 24 %}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "⭐ Notes :",
          "value": {%- set rating_parts = [] -%}
            {%- if item.omdb and item.omdb.imdb_rating and item.omdb.imdb_rating != 'N/A' -%}
              {%- if item.imdb_id -%}
                {%- set _ = rating_parts.append('[**IMDb:** ' ~ item.omdb.imdb_rating ~ '](https://www.imdb.com/title/' ~ item.imdb_id ~ ')') -%}
              {%- else -%}
                {%- set _ = rating_parts.append('**IMDb:** ' ~ item.omdb.imdb_rating) -%}
              {%- endif -%}
            {%- endif -%}
            {%- if item.omdb and item.omdb.ratings_dict.rotten_tomatoes -%}
              {%- set _ = rating_parts.append('**RT:** ' ~ item.omdb.ratings_dict.rotten_tomatoes.value) -%}
            {%- endif -%}
            {%- if item.omdb and item.omdb.metascore and item.omdb.metascore != 'N/A' -%}
              {%- set _ = rating_parts.append('**MC:** ' ~ item.omdb.metascore) -%}
            {%- endif -%}
            {%- if item.tmdb and item.tmdb.rating_display -%}
              {%- if item.tmdb_id -%}
                {%- if item.item_type == 'Movie' -%}
                  {%- set _ = rating_parts.append('[**TMDb:** ' ~ item.tmdb.rating_display ~ '/10](https://www.themoviedb.org/movie/' ~ item.tmdb_id ~ ')') -%}
                {%- elif item.item_type in ['Series', 'Season', 'Episode'] -%}
                  {%- set _ = rating_parts.append('[**TMDb:** ' ~ item.tmdb.rating_display ~ '/10](https://www.themoviedb.org/tv/' ~ item.tmdb_id ~ ')') -%}
                {%- else -%}
                  {%- set _ = rating_parts.append('**TMDb:** ' ~ item.tmdb.rating_display ~ '/10') -%}
                {%- endif -%}
              {%- else -%}
                {%- set _ = rating_parts.append('**TMDb:** ' ~ item.tmdb.rating_display ~ '/10') -%}
              {%- endif -%}
            {%- elif item.omdb and item.omdb.ratings_dict.tmdb -%}
              {%- set _ = rating_parts.append('**TMDb:** ' ~ item.omdb.ratings_dict.tmdb.value) -%}
            {%- endif -%}
            {%- if item.tvdb and item.tvdb.rating -%}
              {%- if item.tvdb_slug -%}
                {%- set _ = rating_parts.append('[**TVDb:** ' ~ item.tvdb.rating ~ '](https://www.thetvdb.com/series/' ~ item.tvdb_slug ~ ')') -%}
              {%- elif item.tvdb_id -%}
                {%- set _ = rating_parts.append('[**TVDb:** ' ~ item.tvdb.rating ~ '](https://www.thetvdb.com/dereferrer/series/' ~ item.tvdb_id ~ ')') -%}
              {%- else -%}
                {%- set _ = rating_parts.append('**TVDb:** ' ~ item.tvdb.rating) -%}
              {%- endif -%}
            {%- endif -%}
            {{ (rating_parts | join(' • ')) | tojson }},
          "inline": false
        }
        {% endif %}
      ]

      {#
        Sélection d'image avec priorité
        --------------------------------
        Priorité : Jellyfin → Affiche OMDb → Artwork TVDb → Toile de fond TMDb
      #}
      {% if item.item_type == 'Episode' and item.series_id %}
      ,"thumbnail": {
        "url": {{ thumbnail_url | tojson }}
      }
      {% elif item.item_id %}
      ,"thumbnail": {
        "url": {{ thumbnail_url | tojson }}
      }
      {% elif item.omdb and item.omdb.poster and item.omdb.poster != 'N/A' %}
      ,"thumbnail": {
        "url": {{ item.omdb.poster | tojson }}
      }
      {% elif item.tvdb and item.tvdb.poster_url %}
      ,"thumbnail": {
        "url": {{ item.tvdb.poster_url | tojson }}
      }
      {% elif item.tmdb and item.tmdb.backdrop_url %}
      ,"image": {
        "url": {{ item.tmdb.backdrop_url | tojson }}
      }
      {% endif %}

      {#
        Pied de page avec attribution des métadonnées
        ----------------------------------------------
        Affiche les sources de données et les infos serveur
      #}
      ,"footer": {
        "text": {{ ((item.library_name or 'Jellyfin') ~
          (" • " ~ item.server_name if item.server_name else "") ~
          (" • IMDb via OMDb" if item.omdb else "") ~
          (" • TheTVDB" if item.tvdb else "") ~
          (" • TMDb" if item.tmdb else "")) | tojson }},
        "icon_url": {{ (jellyfin_url ~ "/web/favicon.png") | tojson }}
      }

      {% if item.item_id %}
      ,"url": {{ (jellyfin_url ~ "/web/index.html#!/details?id=" ~ item.item_id) | tojson }}
      {% endif %}

      ,"timestamp": {{ timestamp | tojson }}
    }
  ]
}
