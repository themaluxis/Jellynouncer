{#
  New Item Jinja2 Discord Webhook Template for Jellynouncer
  ==========================================================

  This template generates Discord embed messages for newly added media items.
  It intelligently uses metadata from multiple sources with proper fallbacks.

  Metadata Source Priority:
  ------------------------
  - TV Shows/Episodes: TVDb → Jellyfin base properties
  - Movies: TMDb → OMDb → Jellyfin base properties
  - Music: Jellyfin base properties only

  Discord Limits Respected:
  ------------------------
  - Max 256 chars for title
  - Max 4096 chars for description
  - Max 25 fields (we use ~10-15)
  - Max 1024 chars per field value
  - Max 6000 chars total per embed
#}
{
  "embeds": [
    {
      {#
        Dynamic Title Based on Item Type
        ---------------------------------
        Shows appropriate emoji and type label for each media category
      #}
      "title": {% if item.item_type == 'Episode' -%}
        {{ ("🆕📺 " ~ ((item.series_name | default('Unknown Series')) ~ " " ~ "S" ~ ("%02d" % (item.season_number | default(0))) ~ "E" ~ ("%02d" % (item.episode_number | default(0))) | truncate(200, True, '...'))) | tojson }}
      {%- elif item.item_type == 'Series' -%}
        {{ ("🆕📺 " ~ (item.name | default('Unknown Series') | truncate(200, True, '...'))) | tojson }}
      {%- elif item.item_type == 'Movie' -%}
        {{ ("🆕🎬 " ~ (item.name | default('Unknown Movie') | truncate(200, True, '...'))) | tojson }}
      {%- elif item.item_type == 'Season' -%}
        {{ ("🆕📺 " ~ (item.series_name | default('Unknown Series')) ~ " - Season " ~ (item.season_number | default('?'))) | tojson }}
      {%- elif item.item_type == 'Audio' -%}
        {{ ("🆕🎵 " ~ (item.name | default('Unknown Song') | truncate(200, True, '...'))) | tojson }}
      {%- elif item.item_type == 'MusicAlbum' -%}
        {{ ("🆕💿 " ~ (item.name | default('Unknown Album') | truncate(200, True, '...'))) | tojson }}
      {%- elif item.item_type == 'MusicArtist' -%}
        {{ ("🆕🎤 " ~ (item.name | default('Unknown Artist') | truncate(200, True, '...'))) | tojson }}
      {%- elif item.item_type == 'Photo' -%}
        {{ ("🆕📷 " ~ (item.name | default('New Photo') | truncate(200, True, '...'))) | tojson }}
      {%- else -%}
        {{ ("🆕📁 " ~ (item.name | default('Unknown ' ~ item.item_type) | truncate(200, True, '...'))) | tojson }}
      {%- endif %},

      {#
        Rich Description with Metadata Priority
        ----------------------------------------
        TV: TVDb overview → Jellyfin overview
        Movies: TMDb overview → OMDb plot → Jellyfin overview
        Music: Artist/album info from Jellyfin
      #}
      "description": {% if item.item_type == 'Episode' -%}
        {{ ("**" ~ (item.name | default('Unknown Episode')) ~ "**" ~
        ("\n\n" ~ "📝 Overview" ~ "\n" ~ ((item.tvdb.overview[:400] ~ '...') if item.tvdb.overview | length > 400 else item.tvdb.overview) if item.tvdb and item.tvdb.overview and item.tvdb.overview | length > 0 else
         "\n\n" ~ ((item.overview[:400] ~ '...') if item.overview | length > 400 else item.overview) if item.overview and item.overview | length > 0 else
         "")) | tojson }}
      {%- elif item.item_type in ['Series', 'Season'] -%}
        {{ ("**" ~ (item.name | default('Unknown Title')) ~ "**" ~
        (" (" ~ item.year ~ ")" if item.year else "") ~
        ("\n\n" ~ ((item.tvdb.overview[:400] ~ '...') if item.tvdb.overview | length > 400 else item.tvdb.overview) if item.tvdb and item.tvdb.overview and item.tvdb.overview | length > 0 else
         "\n\n" ~ ((item.overview[:400] ~ '...') if item.overview | length > 400 else item.overview) if item.overview and item.overview | length > 0 else
         "")) | tojson }}
      {%- elif item.item_type == 'Movie' -%}
        {{ ("**" ~ (item.name | default('Unknown Title')) ~ "**" ~
        (" (" ~ item.year ~ ")" if item.year else "") ~
        ("\n\n" ~ ((item.tmdb.overview[:400] ~ '...') if item.tmdb.overview | length > 400 else item.tmdb.overview) if item.tmdb and item.tmdb.overview and item.tmdb.overview | length > 0 else
         "\n\n" ~ ((item.omdb.plot[:400] ~ '...') if item.omdb.plot | length > 400 else item.omdb.plot) if item.omdb and item.omdb.plot and item.omdb.plot != 'N/A' else
         "\n\n" ~ ((item.overview[:400] ~ '...') if item.overview | length > 400 else item.overview) if item.overview and item.overview | length > 0 else
         "")) | tojson }}
      {%- elif item.item_type == 'Audio' -%}
        {{ ("**" ~ (item.name | default('Unknown Song')) ~ "**" ~
        (" by " ~ (item.artists | join(', ')) if item.artists is defined and item.artists and item.artists | length > 0 else
         " by " ~ item.album_artist if item.album_artist is defined and item.album_artist else
         "") ~
        (" from **" ~ item.album ~ "**" if item.album is defined and item.album else
         "")) | tojson }}
      {%- elif item.item_type == 'MusicAlbum' -%}
        {{ ("**" ~ (item.name | default('Unknown Album')) ~ "**" ~
        (" by " ~ item.album_artist if item.album_artist is defined and item.album_artist else
         " by " ~ (item.artists | join(', ')) if item.artists is defined and item.artists and item.artists | length > 0 else
         "")) | tojson }}
      {%- else -%}
        {{ ("**" ~ (item.name | default('Unknown Title')) ~ "**" ~
        ("\n\n" ~ ((item.overview[:400] ~ '...') if item.overview | length > 400 else item.overview) if item.overview and item.overview | length > 0 else
         "")) | tojson }}
      {%- endif %},

      "color": {{ color }},

      {#
        Smart Field System with Metadata
        ---------------------------------
        Track field count to stay under Discord's 25-field limit
        Show only essential fields for standard template
      #}
      "fields": [
        {%- set fields_added = namespace(count=0) -%}

        {#
          Technical Specifications Row
          -----------------------------
          Video quality, codec, and audio information
        #}
        {% if item.video_height and item.item_type not in ['Audio', 'MusicAlbum', 'MusicArtist'] -%}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "📐 Quality",
          "value": {{ (item.video_height ~ "p" ~
            (" " ~ item.video_range if item.video_range and item.video_range != 'SDR' else "")) | tojson }},
          "inline": true
        }
        {%- endif %}

        {% if item.video_codec and item.item_type not in ['Audio', 'MusicAlbum', 'MusicArtist'] -%}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "🎞️ Video",
          "value": {{ ((item.video_codec | upper) ~
            (" " ~ item.video_profile if item.video_profile else "")) | tojson }},
          "inline": true
        }
        {%- endif %}

        {% if item.audio_codec -%}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "🔊 Audio",
          "value": {{ ((item.audio_codec | upper) ~
            (" Stereo" if item.audio_channels == 2 else
             " 5.1" if item.audio_channels == 6 else
             " 7.1" if item.audio_channels == 8 else
             " " ~ item.audio_channels ~ "ch" if item.audio_channels else "")) | tojson }},
          "inline": true
        }
        {%- endif %}

        {#
          Content Information Row
          ------------------------
          Runtime, genres, and file size with metadata fallbacks
        #}
        {% if item.runtime_ticks or (item.omdb and item.omdb.runtime_minutes) -%}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "⏱️ Runtime",
          "value": {% if item.runtime_ticks -%}
              {%- set minutes = (item.runtime_ticks / 600000000) | int -%}
              {%- set hours = (minutes / 60) | int -%}
              {%- set mins = (minutes % 60) -%}
              {{ (hours ~ "h " ~ mins ~ "m" if hours > 0 else mins ~ " min") | tojson }}
            {%- elif item.omdb and item.omdb.runtime_minutes -%}
              {%- set hours = (item.omdb.runtime_minutes / 60) | int -%}
              {%- set mins = (item.omdb.runtime_minutes % 60) -%}
              {{ (hours ~ "h " ~ mins ~ "m" if hours > 0 else mins ~ " min") | tojson }}
            {%- else -%}
              "N/A"
            {%- endif %},
          "inline": true
        }
        {%- endif %}

        {#
          Genre Information with Source Priority
          ---------------------------------------
          TV: TVDb genres → Jellyfin genres
          Movies: TMDb genres → OMDb genres → Jellyfin genres
        #}
        {% set display_genres = null %}
        {% if item.item_type in ['Series', 'Season', 'Episode'] %}
          {% if item.tvdb and item.tvdb.genres and item.tvdb.genres | length > 0 %}
            {% set display_genres = item.tvdb.genres %}
          {% elif item.genres and item.genres | length > 0 %}
            {% set display_genres = item.genres %}
          {% endif %}
        {% elif item.item_type == 'Movie' %}
          {% if item.tmdb and item.tmdb.genres_list and item.tmdb.genres_list | length > 0 %}
            {% set display_genres = item.tmdb.genres_list %}
          {% elif item.omdb and item.omdb.genres_list and item.omdb.genres_list | length > 0 %}
            {% set display_genres = item.omdb.genres_list %}
          {% elif item.genres and item.genres | length > 0 %}
            {% set display_genres = item.genres %}
          {% endif %}
        {% elif item.genres and item.genres | length > 0 %}
          {% set display_genres = item.genres %}
        {% endif %}

        {% if display_genres and display_genres | length > 0 -%}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "🎭 Genres",
          "value": {{ ((display_genres[:3] | join(', ')) ~
            (" +" ~ (display_genres | length - 3) if display_genres | length > 3 else "")) | tojson }},
          "inline": true
        }
        {%- endif %}

        {% if item.file_size -%}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "💾 Size",
          "value": {{ (("%.1f" % (item.file_size / 1073741824)) ~ " GB") | tojson }},
          "inline": true
        }
        {%- endif %}

        {#
          Comprehensive Ratings Field - Inline Display
          ---------------------------------------------
          Shows all available ratings from all sources in a single line
          Format: IMDb: 8.5 • RT: 94% • MC: 84 • TMDb: 8.3 • TVDb: 9.2
        #}
        {% set has_ratings = false %}
        {% if (item.omdb and (item.omdb.imdb_rating or item.omdb.metascore or
               item.omdb.ratings_dict.rotten_tomatoes)) or
               (item.tmdb and item.tmdb.rating_display) or
               (item.tvdb and item.tvdb.rating) %}
          {% set has_ratings = true %}
        {% endif %}

        {% if has_ratings and fields_added.count < 24 %}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "⭐ Ratings",
          "value": {%- set rating_parts = [] -%}
            {%- if item.omdb and item.omdb.imdb_rating and item.omdb.imdb_rating != 'N/A' -%}
              {%- if item.imdb_id -%}
                {%- set _ = rating_parts.append('[**IMDb:** ' ~ item.omdb.imdb_rating ~ '](https://www.imdb.com/title/' ~ item.imdb_id ~ ')') -%}
              {%- else -%}
                {%- set _ = rating_parts.append('**IMDb:** ' ~ item.omdb.imdb_rating) -%}
              {%- endif -%}
            {%- endif -%}
            {%- if item.omdb and item.omdb.ratings_dict.rotten_tomatoes -%}
              {%- set _ = rating_parts.append('**RT:** ' ~ item.omdb.ratings_dict.rotten_tomatoes.value) -%}
            {%- endif -%}
            {%- if item.omdb and item.omdb.metascore and item.omdb.metascore != 'N/A' -%}
              {%- set _ = rating_parts.append('**MC:** ' ~ item.omdb.metascore) -%}
            {%- endif -%}
            {%- if item.tmdb and item.tmdb.rating_display -%}
              {%- if item.tmdb_id -%}
                {%- if item.item_type == 'Movie' -%}
                  {%- set _ = rating_parts.append('[**TMDb:** ' ~ item.tmdb.rating_display ~ '/10](https://www.themoviedb.org/movie/' ~ item.tmdb_id ~ ')') -%}
                {%- elif item.item_type in ['Series', 'Season', 'Episode'] -%}
                  {%- set _ = rating_parts.append('[**TMDb:** ' ~ item.tmdb.rating_display ~ '/10](https://www.themoviedb.org/tv/' ~ item.tmdb_id ~ ')') -%}
                {%- else -%}
                  {%- set _ = rating_parts.append('**TMDb:** ' ~ item.tmdb.rating_display ~ '/10') -%}
                {%- endif -%}
              {%- else -%}
                {%- set _ = rating_parts.append('**TMDb:** ' ~ item.tmdb.rating_display ~ '/10') -%}
              {%- endif -%}
            {%- elif item.omdb and item.omdb.ratings_dict.tmdb -%}
              {%- set _ = rating_parts.append('**TMDb:** ' ~ item.omdb.ratings_dict.tmdb.value) -%}
            {%- endif -%}
            {%- if item.tvdb and item.tvdb.rating -%}
              {%- if item.tvdb_slug -%}
                {%- set _ = rating_parts.append('[**TVDb:** ' ~ item.tvdb.rating ~ '](https://www.thetvdb.com/series/' ~ item.tvdb_slug ~ ')') -%}
              {%- elif item.tvdb_id -%}
                {%- set _ = rating_parts.append('[**TVDb:** ' ~ item.tvdb.rating ~ '](https://www.thetvdb.com/dereferrer/series/' ~ item.tvdb_id ~ ')') -%}
              {%- else -%}
                {%- set _ = rating_parts.append('**TVDb:** ' ~ item.tvdb.rating) -%}
              {%- endif -%}
            {%- endif -%}
            {{ (rating_parts | join(' • ')) | tojson }},
          "inline": false
        }
        {% endif %}
      ]

      {#
        Image Selection with Priority
        ------------------------------
        Priority: Jellyfin → OMDb poster → TVDb artwork → TMDb backdrop
      #}
      {% if item.item_type == 'Episode' and item.series_id %}
      ,"thumbnail": {
        "url": {{ thumbnail_url | tojson }}
      }
      {% elif item.item_id %}
      ,"thumbnail": {
        "url": {{ thumbnail_url | tojson }}
      }
      {% elif item.omdb and item.omdb.poster and item.omdb.poster != 'N/A' %}
      ,"thumbnail": {
        "url": {{ item.omdb.poster | tojson }}
      }
      {% elif item.tvdb and item.tvdb.poster_url %}
      ,"thumbnail": {
        "url": {{ item.tvdb.poster_url | tojson }}
      }
      {% elif item.tmdb and item.tmdb.backdrop_url %}
      ,"image": {
        "url": {{ item.tmdb.backdrop_url | tojson }}
      }
      {% endif %}

      {#
        Footer with Metadata Attribution
        ---------------------------------
        Shows data sources and server info
      #}
      ,"footer": {
        "text": {{ ((item.library_name or 'Jellyfin') ~
          (" • " ~ item.server_name if item.server_name else "") ~
          (" • IMDb via OMDb" if item.omdb else "") ~
          (" • TheTVDB" if item.tvdb else "") ~
          (" • TMDb" if item.tmdb else "")) | tojson }},
        "icon_url": {{ (jellyfin_url ~ "/web/favicon.png") | tojson }}
      }

      {% if item.item_id %}
      ,"url": {{ (jellyfin_url ~ "/web/index.html#!/details?id=" ~ item.item_id) | tojson }}
      {% endif %}

      ,"timestamp": {{ timestamp | tojson }}
    }
  ]
}
