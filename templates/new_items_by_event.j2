{#
  ModÃ¨le de Nouveaux Ã‰lÃ©ments par Ã‰vÃ©nement pour Jellynouncer
  ================================================================

  Regroupe plusieurs nouveaux Ã©lÃ©ments en une seule notification.
  Affiche les informations de base pour chaque Ã©lÃ©ment avec amÃ©lioration des mÃ©tadonnÃ©es.

  OptimisÃ© pour : Plusieurs Ã©lÃ©ments ajoutÃ©s en une fois
  Limites Discord : Respecte le nombre de champs et les limites de caractÃ¨res
#}
{
  "embeds": [
    {
      "title": {{ ("ðŸ†• " ~ (total_items | string) ~ " nouveaux Ã©lÃ©ments ajoutÃ©s") | tojson }},

      "description": "Les Ã©lÃ©ments suivants ont Ã©tÃ© ajoutÃ©s Ã  Jellyfin :",

      "color": 65280,

      "fields": [
        {% set field_count = namespace(value=0) %}

        {#
          Traiter chaque Ã©lÃ©ment avec mÃ©tadonnÃ©es
          -----------------------------------------------
          Limiter Ã  20 Ã©lÃ©ments pour rester dans les limites de champs
        #}
        {% for item_data in new_items[:20] %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": {{ (item_data.item.item_type ~ ": " ~ ((item_data.item.name[:200] + '...') if item_data.item.name|length > 200 else item_data.item.name)) | tojson }},

          "value": {{ (
            (item_data.item.series_name ~ \" S\" ~ ('%02d'|format(item_data.item.season_number or 0)) ~ \"E\" ~ ('%02d'|format(item_data.item.episode_number or 0))
             if item_data.item.item_type == 'Episode' else \"\") ~

            (\"\\nðŸ“ \" ~ item_data.item.video_height ~ \"p\" ~
             (\" \" ~ item_data.item.video_range if item_data.item.video_range and item_data.item.video_range != 'SDR' else \"\")
             if item_data.item.video_height else \"\") ~

            (\" â€¢ ðŸŽžï¸ \" ~ (item_data.item.video_codec | upper) if item_data.item.video_codec else \"\") ~

            (\" â€¢ ðŸ”Š \" ~ (item_data.item.audio_codec | upper) if item_data.item.audio_codec else \"\") ~

            {#
              Ajouter la note principale si disponible
              -----------------------------------------
              PrioritÃ© : IMDb â†’ TMDb â†’ TVDb
            #}
            (\"\\nâ­ IMDb: \" ~ item_data.item.omdb.imdb_rating if item_data.item.omdb and item_data.item.omdb.imdb_rating and item_data.item.omdb.imdb_rating != 'N/A'
             else \"\\nâ­ TMDb: \" ~ item_data.item.tmdb.rating_display ~ "/10" if item_data.item.tmdb and item_data.item.tmdb.rating_display
             else \"\\nâ­ TVDb: \" ~ item_data.item.tvdb.rating if item_data.item.tvdb and item_data.item.tvdb.rating
             else \"\")
          ) | tojson }},

          "inline": true
        }
        {% endfor %}

        {% if new_items|length > 20 %}
          {% if field_count.value > 0 %},{% endif %}
        {
          "name": "âž• Ã‰lÃ©ments supplÃ©mentaires :",
          "value": {{ ("Et " ~ ((new_items|length - 20) | string) ~ " Ã©lÃ©ments de plus...") | tojson }},
          "inline": false
        }
        {% endif %}
      ],

      "footer": {
        "text": {{ ("Jellyfin" ~
          (" â€¢ " ~ new_items[0].item.server_name if new_items[0].item.server_name else "") ~
          {%- set has_omdb = new_items | selectattr('item.omdb') | list | length > 0 -%}
          {%- set has_tvdb = new_items | selectattr('item.tvdb') | list | length > 0 -%}
          {%- set has_tmdb = new_items | selectattr('item.tmdb') | list | length > 0 -%}
          (" â€¢ IMDb via OMDb" if has_omdb else "") ~
          (" â€¢ TheTVDB" if has_tvdb else "") ~
          (" â€¢ TMDb" if has_tmdb else "")
        ) | tojson }},
        "icon_url": {{ (jellyfin_url ~ "/web/favicon.png") | tojson }}
      },

      "timestamp": {{ timestamp | tojson }}
    }
  ]
}
