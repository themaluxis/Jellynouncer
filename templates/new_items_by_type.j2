{#
  Modèle de Nouveaux Éléments par Type pour Jellynouncer
  ==========================================================

  Regroupe les nouveaux éléments par type de média (films, TV, musique, autre).
  Affiche des informations spécifiques à la catégorie avec enrichissement des métadonnées.

  Catégories : films, tv, musique, autre
  Limites Discord : Respecte la limite de 25 champs par embed
#}
{
  "embeds": [
    {% if category == 'movies' %}
    {
      "title": {{ ("🎬 Nouveaux Films Ajoutés (" ~ (total_items | string) ~ ")") | tojson }},
      "description": "Les films suivants ont été ajoutés à Jellyfin :",
      "color": 65280,

      "fields": [
        {% set field_count = namespace(value=0) %}

        {#
          Traiter les films avec métadonnées complètes
          --------------------------------------------------
          Inclure notes, année, informations de qualité
        #}
        {% for item_data in new_items[:8] %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": {{ (((item_data.item.name[:230] + '...') if item_data.item.name|length > 230 else item_data.item.name) ~
            (\" (\" ~ item_data.item.year ~ \")\" if item_data.item.year else \"\")
          ) | tojson }},

          "value": {{ (
            {#
              Aperçu du film avec priorité des métadonnées
              -----------------------------------------------------
              TMDb → OMDb → Jellyfin
            #}
            (\"*\" ~ ((item_data.item.tmdb.overview[:150] + '...') if item_data.item.tmdb.overview|length > 150 else item_data.item.tmdb.overview) ~ \"*\\n\" if item_data.item.tmdb and item_data.item.tmdb.overview
             else \"*\" ~ ((item_data.item.omdb.plot[:150] + '...') if item_data.item.omdb.plot|length > 150 else item_data.item.omdb.plot) ~ \"*\\n\" if item_data.item.omdb and item_data.item.omdb.plot and item_data.item.omdb.plot != 'N/A'
             else \"*\" ~ ((item_data.item.overview[:150] + '...') if item_data.item.overview|length > 150 else item_data.item.overview) ~ \"*\\n\" if item_data.item.overview
             else \"\") ~

            (\"📐 \" ~ item_data.item.video_height ~ \"p\" ~
             (\" \" ~ item_data.item.video_range if item_data.item.video_range and item_data.item.video_range != 'SDR' else \"\")
             if item_data.item.video_height else \"\") ~

            (\" • 🎞️ \" ~ (item_data.item.video_codec|upper) if item_data.item.video_codec else \"\") ~

            (\" • 🔊 \" ~ (item_data.item.audio_codec|upper) ~
             (item_data.item.audio_channels ~ \".\" ~ (\"1\" if item_data.item.audio_channels > 2 else \"0\") if item_data.item.audio_channels else \"\")
             if item_data.item.audio_codec else \"\") ~

            {#
              Affichage des notes en ligne pour les films
              -------------------------------------------
              Afficher toutes les notes disponibles sur une ligne
            #}
            {%- set rating_parts = [] -%}
            {%- if item_data.item.omdb and item_data.item.omdb.imdb_rating and item_data.item.omdb.imdb_rating != 'N/A' -%}
              {%- set _ = rating_parts.append('IMDb: ' ~ item_data.item.omdb.imdb_rating) -%}
            {%- endif -%}
            {%- if item_data.item.omdb and item_data.item.omdb.ratings_dict.rotten_tomatoes -%}
              {%- set _ = rating_parts.append('RT: ' ~ item_data.item.omdb.ratings_dict.rotten_tomatoes.value) -%}
            {%- endif -%}
            {%- if item_data.item.tmdb and item_data.item.tmdb.rating_display -%}
              {%- set _ = rating_parts.append('TMDb: ' ~ item_data.item.tmdb.rating_display ~ '/10') -%}
            {%- endif -%}
            (\"\\n⭐ \" ~ (rating_parts | join(' • ')) if rating_parts|length > 0 else \"\") ~

            {#
              Affichage des genres avec priorité des métadonnées
              ---------------------------------------------------------
              TMDb → OMDb → Jellyfin
            #}
            {%- set display_genres = null -%}
            {%- if item_data.item.tmdb and item_data.item.tmdb.genres_list -%}
              {%- set display_genres = item_data.item.tmdb.genres_list -%}
            {%- elif item_data.item.omdb and item_data.item.omdb.genres_list -%}
              {%- set display_genres = item_data.item.omdb.genres_list -%}
            {%- elif item_data.item.genres -%}
              {%- set display_genres = item_data.item.genres -%}
            {%- endif -%}
            (\"\\n🎭 \" ~ (display_genres[:3] | join(', ')) if display_genres and display_genres|length > 0 else \"\")
          ) | tojson }},

          "inline": false
        }
        {% endfor %}

        {% if new_items|length > 8 %}
          {% if field_count.value > 0 %},{% endif %}
        {
          "name": "➕ Films Supplémentaires",
          "value": {{ ("Et " ~ ((new_items|length - 8) | string) ~ " films ajoutés de plus...") | tojson }},
          "inline": false
        }
        {% endif %}
      ]
    }

    {% elif category == 'tv' %}
    {
      "title": {{ ("📺 Nouveau Contenu TV Ajouté (" ~ (total_items | string) ~ ")") | tojson }},
      "description": "Les séries TV/épisodes suivants ont été ajoutés à Jellyfin :",
      "color": 65280,

      "fields": [
        {% set field_count = namespace(value=0) %}

        {#
          Traiter le contenu TV avec priorité TVDb
          -------------------------------------------
          TVDb → Propriétés de base Jellyfin
        #}
        {% for item_data in new_items[:8] %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "{% if item_data.item.item_type == 'Episode' -%}
              📺 Épisode : {{ item_data.item.series_name }} - {{ item_data.item.name }}
            {%- elif item_data.item.item_type == 'Series' -%}
              📺 Série : {{ item_data.item.name }}
            {%- else -%}
              📺 {{ item_data.item.item_type }}: {{ item_data.item.name }}
            {%- endif %}",

          "value": "
            {%- if item_data.item.item_type == 'Episode' -%}
              S{{ '%02d'|format(item_data.item.season_number or 0) }}E{{ '%02d'|format(item_data.item.episode_number or 0) }}
            {%- endif -%}

            {#
              Aperçu TV avec priorité TVDb
              --------------------------------
            #}
            {%- if item_data.item.tvdb and item_data.item.tvdb.overview -%}
              \n*{{ (item_data.item.tvdb.overview[:150] + '...') if item_data.item.tvdb.overview|length > 150 else item_data.item.tvdb.overview }}*
            {%- elif item_data.item.overview -%}
              \n*{{ (item_data.item.overview[:150] + '...') if item_data.item.overview|length > 150 else item_data.item.overview }}*
            {%- endif -%}

            {%- if item_data.item.video_height -%}
              \n📐 {{ item_data.item.video_height }}p
              {%- if item_data.item.video_range and item_data.item.video_range != 'SDR' %} {{ item_data.item.video_range }}{% endif -%}
            {%- endif -%}

            {%- if item_data.item.video_codec -%}
              • 🎞️ {{ item_data.item.video_codec|upper }}
            {%- endif -%}

            {#
              Notes TV avec affichage en ligne
              ----------------------------------
            #}
            {%- set rating_parts = [] -%}
            {%- if item_data.item.tvdb and item_data.item.tvdb.rating -%}
              {%- set _ = rating_parts.append('TVDb: ' ~ item_data.item.tvdb.rating) -%}
            {%- endif -%}
            {%- if item_data.item.omdb and item_data.item.omdb.imdb_rating and item_data.item.omdb.imdb_rating != 'N/A' -%}
              {%- set _ = rating_parts.append('IMDb: ' ~ item_data.item.omdb.imdb_rating) -%}
            {%- endif -%}
            {%- if rating_parts|length > 0 -%}
              \n⭐ {{ rating_parts | join(' • ') }}
            {%- endif -%}

            {#
              Genres TV avec priorité TVDb
              --------------------------------
            #}
            {%- if item_data.item.tvdb and item_data.item.tvdb.genres -%}
              \n🎭 {{ item_data.item.tvdb.genres[:3] | join(', ') }}
            {%- elif item_data.item.genres -%}
              \n🎭 {{ item_data.item.genres[:3] | join(', ') }}
            {%- endif -%}

            {%- if item_data.item.tvdb and item_data.item.tvdb.status -%}
              \n📺 Statut : {{ item_data.item.tvdb.status }}
            {%- endif %}",

          "inline": false
        }
        {% endfor %}

        {% if new_items|length > 8 %}
          {% if field_count.value > 0 %},{% endif %}
        {
          "name": "➕ Contenu TV Supplémentaire",
          "value": {{ ("Et " ~ ((new_items|length - 8) | string) ~ " éléments TV ajoutés de plus...") | tojson }},
          "inline": false
        }
        {% endif %}
      ]
    }

    {% elif category == 'music' %}
    {
      "title": {{ ("🎵 Nouvelle Musique Ajoutée (" ~ (total_items | string) ~ ")") | tojson }},
      "description": "La musique suivante a été ajoutée à Jellyfin :",
      "color": 65280,

      "fields": [
        {% set field_count = namespace(value=0) %}

        {#
          Traiter le contenu musical
          ----------------------------
          La musique utilise uniquement les propriétés Jellyfin (pas de métadonnées externes)
        #}
        {% for item_data in new_items[:10] %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "{% if item_data.item.item_type == 'Audio' -%}
              🎵 {{ item_data.item.name }}
            {%- elif item_data.item.item_type == 'MusicAlbum' -%}
              💿 {{ item_data.item.name }}
            {%- elif item_data.item.item_type == 'MusicArtist' -%}
              🎤 {{ item_data.item.name }}
            {%- else -%}
              🎵 {{ item_data.item.name }}
            {%- endif %}",

          "value": "
            {%- if item_data.item.item_type == 'Audio' -%}
              {%- if item_data.item.album %}Album : {{ item_data.item.album }}\n{% endif -%}
              {%- if item_data.item.artists %}Artiste : {{ item_data.item.artists | join(', ') }}\n{% endif -%}
            {%- elif item_data.item.item_type == 'MusicAlbum' -%}
              {%- if item_data.item.album_artist %}Artiste : {{ item_data.item.album_artist }}\n{% endif -%}
              {%- if item_data.item.year %}Année : {{ item_data.item.year }}\n{% endif -%}
            {%- endif -%}

            {%- if item_data.item.audio_codec -%}
              🔊 {{ item_data.item.audio_codec|upper }}
              {%- if item_data.item.audio_bitrate %} @ {{ (item_data.item.audio_bitrate / 1000)|round(0) }} kbps{% endif -%}
            {%- endif -%}

            {%- if item_data.item.runtime_ticks -%}
              {%- set minutes = (item_data.item.runtime_ticks / 600000000) | int -%}
              {%- set seconds = (((item_data.item.runtime_ticks / 10000000) | int) % 60) -%}
              \n⏱️ {{ minutes }}:{{ "%02d" % seconds }}
            {%- endif -%}

            {%- if item_data.item.genres and item_data.item.genres|length > 0 -%}
              \n🎭 {{ item_data.item.genres[:2] | join(', ') }}
            {%- endif %}",

          "inline": true
        }
        {% endfor %}

        {% if new_items|length > 10 %}
          {% if field_count.value > 0 %},{% endif %}
        {
          "name": "➕ Musique Supplémentaire",
          "value": {{ ("Et " ~ ((new_items|length - 10) | string) ~ " éléments musicaux ajoutés de plus...") | tojson }},
          "inline": false
        }
        {% endif %}
      ]
    }

    {% else %}
    {#
      Autre catégorie (photos, livres, etc.)
      -----------------------------------------
    #}
    {
      "title": {{ ("📁 Nouveaux Éléments Ajoutés (" ~ (total_items | string) ~ ")") | tojson }},
      "description": "Les éléments suivants ont été ajoutés à Jellyfin :",
      "color": 65280,

      "fields": [
        {% set field_count = namespace(value=0) %}

        {% for item_data in new_items[:15] %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "{{ item_data.item.item_type }}: {{ (item_data.item.name[:200] + '...')
            if item_data.item.name|length > 200 else item_data.item.name }}",

          "value": "
            {%- if item_data.item.overview -%}
              {{ (item_data.item.overview[:100] + '...') if item_data.item.overview|length > 100 else item_data.item.overview }}
            {%- else -%}
              {{ item_data.item.item_type }} ajouté
            {%- endif -%}

            {%- if item_data.item.width and item_data.item.height -%}
              \n📐 {{ item_data.item.width }}×{{ item_data.item.height }}
            {%- endif -%}

            {%- if item_data.item.file_size -%}
              \n💾 {{ '%.1f'|format(item_data.item.file_size / 1048576) }} MB
            {%- endif %}",

          "inline": true
        }
        {% endfor %}

        {% if new_items|length > 15 %}
          {% if field_count.value > 0 %},{% endif %}
        {
          "name": "➕ Éléments Supplémentaires",
          "value": {{ ("Et " ~ ((new_items|length - 15) | string) ~ " éléments ajoutés de plus...") | tojson }},
          "inline": false
        }
        {% endif %}
      ]
    }
    {% endif %}
    ,

    "footer": {
      "text": {{ ("Jellyfin" ~
        (" • " ~ new_items[0].item.server_name if new_items[0].item.server_name else "") ~
        {%- set has_omdb = new_items | selectattr('item.omdb') | list | length > 0 -%}
        {%- set has_tvdb = new_items | selectattr('item.tvdb') | list | length > 0 -%}
        {%- set has_tmdb = new_items | selectattr('item.tmdb') | list | length > 0 -%}
        (" • IMDb via OMDb" if has_omdb else "") ~
        (" • TheTVDB" if has_tvdb else "") ~
        (" • TMDb" if has_tmdb else "")
      ) | tojson }},
      "icon_url": {{ (jellyfin_url ~ "/web/favicon.png") | tojson }}
    },

    "timestamp": {{ timestamp | tojson }}
  ]
}
