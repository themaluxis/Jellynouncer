{#
  ModÃ¨le de Nouveaux Ã‰lÃ©ments par Type pour Jellynouncer
  ==========================================================

  Regroupe les nouveaux Ã©lÃ©ments par type de mÃ©dia (films, TV, musique, autre).
  Affiche des informations spÃ©cifiques Ã  la catÃ©gorie avec enrichissement des mÃ©tadonnÃ©es.

  CatÃ©gories : films, tv, musique, autre
  Limites Discord : Respecte la limite de 25 champs par embed
#}
{
  "embeds": [
    {% if category == 'movies' %}
    {
      "title": {{ ("ðŸŽ¬ Nouveaux Films AjoutÃ©s (" ~ (total_items | string) ~ ")") | tojson }},
      "description": "Les films suivants ont Ã©tÃ© ajoutÃ©s Ã  Jellyfin :",
      "color": 65280,

      "fields": [
        {% set field_count = namespace(value=0) %}

        {#
          Traiter les films avec mÃ©tadonnÃ©es complÃ¨tes
          --------------------------------------------------
          Inclure notes, annÃ©e, informations de qualitÃ©
        #}
        {% for item_data in new_items[:8] %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": {{ (((item_data.item.name[:230] + '...') if item_data.item.name|length > 230 else item_data.item.name) ~
            (\" (\" ~ item_data.item.year ~ \")\" if item_data.item.year else \"\")
          ) | tojson }},

          "value": {{ (
            {#
              AperÃ§u du film avec prioritÃ© des mÃ©tadonnÃ©es
              -----------------------------------------------------
              TMDb â†’ OMDb â†’ Jellyfin
            #}
            (\"*\" ~ ((item_data.item.tmdb.overview[:150] + '...') if item_data.item.tmdb.overview|length > 150 else item_data.item.tmdb.overview) ~ \"*\\n\" if item_data.item.tmdb and item_data.item.tmdb.overview
             else \"*\" ~ ((item_data.item.omdb.plot[:150] + '...') if item_data.item.omdb.plot|length > 150 else item_data.item.omdb.plot) ~ \"*\\n\" if item_data.item.omdb and item_data.item.omdb.plot and item_data.item.omdb.plot != 'N/A'
             else \"*\" ~ ((item_data.item.overview[:150] + '...') if item_data.item.overview|length > 150 else item_data.item.overview) ~ \"*\\n\" if item_data.item.overview
             else \"\") ~

            (\"ðŸ“ \" ~ item_data.item.video_height ~ \"p\" ~
             (\" \" ~ item_data.item.video_range if item_data.item.video_range and item_data.item.video_range != 'SDR' else \"\")
             if item_data.item.video_height else \"\") ~

            (\" â€¢ ðŸŽžï¸ \" ~ (item_data.item.video_codec|upper) if item_data.item.video_codec else \"\") ~

            (\" â€¢ ðŸ”Š \" ~ (item_data.item.audio_codec|upper) ~
             (item_data.item.audio_channels ~ \".\" ~ (\"1\" if item_data.item.audio_channels > 2 else \"0\") if item_data.item.audio_channels else \"\")
             if item_data.item.audio_codec else \"\") ~

            {#
              Affichage des notes en ligne pour les films
              -------------------------------------------
              Afficher toutes les notes disponibles sur une ligne
            #}
            {%- set rating_parts = [] -%}
            {%- if item_data.item.omdb and item_data.item.omdb.imdb_rating and item_data.item.omdb.imdb_rating != 'N/A' -%}
              {%- set _ = rating_parts.append('IMDb: ' ~ item_data.item.omdb.imdb_rating) -%}
            {%- endif -%}
            {%- if item_data.item.omdb and item_data.item.omdb.ratings_dict.rotten_tomatoes -%}
              {%- set _ = rating_parts.append('RT: ' ~ item_data.item.omdb.ratings_dict.rotten_tomatoes.value) -%}
            {%- endif -%}
            {%- if item_data.item.tmdb and item_data.item.tmdb.rating_display -%}
              {%- set _ = rating_parts.append('TMDb: ' ~ item_data.item.tmdb.rating_display ~ '/10') -%}
            {%- endif -%}
            (\"\\nâ­ \" ~ (rating_parts | join(' â€¢ ')) if rating_parts|length > 0 else \"\") ~

            {#
              Affichage des genres avec prioritÃ© des mÃ©tadonnÃ©es
              ---------------------------------------------------------
              TMDb â†’ OMDb â†’ Jellyfin
            #}
            {%- set display_genres = null -%}
            {%- if item_data.item.tmdb and item_data.item.tmdb.genres_list -%}
              {%- set display_genres = item_data.item.tmdb.genres_list -%}
            {%- elif item_data.item.omdb and item_data.item.omdb.genres_list -%}
              {%- set display_genres = item_data.item.omdb.genres_list -%}
            {%- elif item_data.item.genres -%}
              {%- set display_genres = item_data.item.genres -%}
            {%- endif -%}
            (\"\\nðŸŽ­ \" ~ (display_genres[:3] | join(', ')) if display_genres and display_genres|length > 0 else \"\")
          ) | tojson }},

          "inline": false
        }
        {% endfor %}

        {% if new_items|length > 8 %}
          {% if field_count.value > 0 %},{% endif %}
        {
          "name": "âž• Films SupplÃ©mentaires",
          "value": {{ ("Et " ~ ((new_items|length - 8) | string) ~ " films ajoutÃ©s de plus...") | tojson }},
          "inline": false
        }
        {% endif %}
      ]
    }

    {% elif category == 'tv' %}
    {
      "title": {{ ("ðŸ“º Nouveau Contenu TV AjoutÃ© (" ~ (total_items | string) ~ ")") | tojson }},
      "description": "Les sÃ©ries TV/Ã©pisodes suivants ont Ã©tÃ© ajoutÃ©s Ã  Jellyfin :",
      "color": 65280,

      "fields": [
        {% set field_count = namespace(value=0) %}

        {#
          Traiter le contenu TV avec prioritÃ© TVDb
          -------------------------------------------
          TVDb â†’ PropriÃ©tÃ©s de base Jellyfin
        #}
        {% for item_data in new_items[:8] %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "{% if item_data.item.item_type == 'Episode' -%}
              ðŸ“º Ã‰pisode : {{ item_data.item.series_name }} - {{ item_data.item.name }}
            {%- elif item_data.item.item_type == 'Series' -%}
              ðŸ“º SÃ©rie : {{ item_data.item.name }}
            {%- else -%}
              ðŸ“º {{ item_data.item.item_type }}: {{ item_data.item.name }}
            {%- endif %}",

          "value": "
            {%- if item_data.item.item_type == 'Episode' -%}
              S{{ '%02d'|format(item_data.item.season_number or 0) }}E{{ '%02d'|format(item_data.item.episode_number or 0) }}
            {%- endif -%}

            {#
              AperÃ§u TV avec prioritÃ© TVDb
              --------------------------------
            #}
            {%- if item_data.item.tvdb and item_data.item.tvdb.overview -%}
              \n*{{ (item_data.item.tvdb.overview[:150] + '...') if item_data.item.tvdb.overview|length > 150 else item_data.item.tvdb.overview }}*
            {%- elif item_data.item.overview -%}
              \n*{{ (item_data.item.overview[:150] + '...') if item_data.item.overview|length > 150 else item_data.item.overview }}*
            {%- endif -%}

            {%- if item_data.item.video_height -%}
              \nðŸ“ {{ item_data.item.video_height }}p
              {%- if item_data.item.video_range and item_data.item.video_range != 'SDR' %} {{ item_data.item.video_range }}{% endif -%}
            {%- endif -%}

            {%- if item_data.item.video_codec -%}
              â€¢ ðŸŽžï¸ {{ item_data.item.video_codec|upper }}
            {%- endif -%}

            {#
              Notes TV avec affichage en ligne
              ----------------------------------
            #}
            {%- set rating_parts = [] -%}
            {%- if item_data.item.tvdb and item_data.item.tvdb.rating -%}
              {%- set _ = rating_parts.append('TVDb: ' ~ item_data.item.tvdb.rating) -%}
            {%- endif -%}
            {%- if item_data.item.omdb and item_data.item.omdb.imdb_rating and item_data.item.omdb.imdb_rating != 'N/A' -%}
              {%- set _ = rating_parts.append('IMDb: ' ~ item_data.item.omdb.imdb_rating) -%}
            {%- endif -%}
            {%- if rating_parts|length > 0 -%}
              \nâ­ {{ rating_parts | join(' â€¢ ') }}
            {%- endif -%}

            {#
              Genres TV avec prioritÃ© TVDb
              --------------------------------
            #}
            {%- if item_data.item.tvdb and item_data.item.tvdb.genres -%}
              \nðŸŽ­ {{ item_data.item.tvdb.genres[:3] | join(', ') }}
            {%- elif item_data.item.genres -%}
              \nðŸŽ­ {{ item_data.item.genres[:3] | join(', ') }}
            {%- endif -%}

            {%- if item_data.item.tvdb and item_data.item.tvdb.status -%}
              \nðŸ“º Statut : {{ item_data.item.tvdb.status }}
            {%- endif %}",

          "inline": false
        }
        {% endfor %}

        {% if new_items|length > 8 %}
          {% if field_count.value > 0 %},{% endif %}
        {
          "name": "âž• Contenu TV SupplÃ©mentaire",
          "value": {{ ("Et " ~ ((new_items|length - 8) | string) ~ " Ã©lÃ©ments TV ajoutÃ©s de plus...") | tojson }},
          "inline": false
        }
        {% endif %}
      ]
    }

    {% elif category == 'music' %}
    {
      "title": {{ ("ðŸŽµ Nouvelle Musique AjoutÃ©e (" ~ (total_items | string) ~ ")") | tojson }},
      "description": "La musique suivante a Ã©tÃ© ajoutÃ©e Ã  Jellyfin :",
      "color": 65280,

      "fields": [
        {% set field_count = namespace(value=0) %}

        {#
          Traiter le contenu musical
          ----------------------------
          La musique utilise uniquement les propriÃ©tÃ©s Jellyfin (pas de mÃ©tadonnÃ©es externes)
        #}
        {% for item_data in new_items[:10] %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "{% if item_data.item.item_type == 'Audio' -%}
              ðŸŽµ {{ item_data.item.name }}
            {%- elif item_data.item.item_type == 'MusicAlbum' -%}
              ðŸ’¿ {{ item_data.item.name }}
            {%- elif item_data.item.item_type == 'MusicArtist' -%}
              ðŸŽ¤ {{ item_data.item.name }}
            {%- else -%}
              ðŸŽµ {{ item_data.item.name }}
            {%- endif %}",

          "value": "
            {%- if item_data.item.item_type == 'Audio' -%}
              {%- if item_data.item.album %}Album : {{ item_data.item.album }}\n{% endif -%}
              {%- if item_data.item.artists %}Artiste : {{ item_data.item.artists | join(', ') }}\n{% endif -%}
            {%- elif item_data.item.item_type == 'MusicAlbum' -%}
              {%- if item_data.item.album_artist %}Artiste : {{ item_data.item.album_artist }}\n{% endif -%}
              {%- if item_data.item.year %}AnnÃ©e : {{ item_data.item.year }}\n{% endif -%}
            {%- endif -%}

            {%- if item_data.item.audio_codec -%}
              ðŸ”Š {{ item_data.item.audio_codec|upper }}
              {%- if item_data.item.audio_bitrate %} @ {{ (item_data.item.audio_bitrate / 1000)|round(0) }} kbps{% endif -%}
            {%- endif -%}

            {%- if item_data.item.runtime_ticks -%}
              {%- set minutes = (item_data.item.runtime_ticks / 600000000) | int -%}
              {%- set seconds = (((item_data.item.runtime_ticks / 10000000) | int) % 60) -%}
              \nâ±ï¸ {{ minutes }}:{{ "%02d" % seconds }}
            {%- endif -%}

            {%- if item_data.item.genres and item_data.item.genres|length > 0 -%}
              \nðŸŽ­ {{ item_data.item.genres[:2] | join(', ') }}
            {%- endif %}",

          "inline": true
        }
        {% endfor %}

        {% if new_items|length > 10 %}
          {% if field_count.value > 0 %},{% endif %}
        {
          "name": "âž• Musique SupplÃ©mentaire",
          "value": {{ ("Et " ~ ((new_items|length - 10) | string) ~ " Ã©lÃ©ments musicaux ajoutÃ©s de plus...") | tojson }},
          "inline": false
        }
        {% endif %}
      ]
    }

    {% else %}
    {#
      Autre catÃ©gorie (photos, livres, etc.)
      -----------------------------------------
    #}
    {
      "title": {{ ("ðŸ“ Nouveaux Ã‰lÃ©ments AjoutÃ©s (" ~ (total_items | string) ~ ")") | tojson }},
      "description": "Les Ã©lÃ©ments suivants ont Ã©tÃ© ajoutÃ©s Ã  Jellyfin :",
      "color": 65280,

      "fields": [
        {% set field_count = namespace(value=0) %}

        {% for item_data in new_items[:15] %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "{{ item_data.item.item_type }}: {{ (item_data.item.name[:200] + '...')
            if item_data.item.name|length > 200 else item_data.item.name }}",

          "value": "
            {%- if item_data.item.overview -%}
              {{ (item_data.item.overview[:100] + '...') if item_data.item.overview|length > 100 else item_data.item.overview }}
            {%- else -%}
              {{ item_data.item.item_type }} ajoutÃ©
            {%- endif -%}

            {%- if item_data.item.width and item_data.item.height -%}
              \nðŸ“ {{ item_data.item.width }}Ã—{{ item_data.item.height }}
            {%- endif -%}

            {%- if item_data.item.file_size -%}
              \nðŸ’¾ {{ '%.1f'|format(item_data.item.file_size / 1048576) }} MB
            {%- endif %}",

          "inline": true
        }
        {% endfor %}

        {% if new_items|length > 15 %}
          {% if field_count.value > 0 %},{% endif %}
        {
          "name": "âž• Ã‰lÃ©ments SupplÃ©mentaires",
          "value": {{ ("Et " ~ ((new_items|length - 15) | string) ~ " Ã©lÃ©ments ajoutÃ©s de plus...") | tojson }},
          "inline": false
        }
        {% endif %}
      ]
    }
    {% endif %}
    ,

    "footer": {
      "text": {{ ("Jellyfin" ~
        (" â€¢ " ~ new_items[0].item.server_name if new_items[0].item.server_name else "") ~
        {%- set has_omdb = new_items | selectattr('item.omdb') | list | length > 0 -%}
        {%- set has_tvdb = new_items | selectattr('item.tvdb') | list | length > 0 -%}
        {%- set has_tmdb = new_items | selectattr('item.tmdb') | list | length > 0 -%}
        (" â€¢ IMDb via OMDb" if has_omdb else "") ~
        (" â€¢ TheTVDB" if has_tvdb else "") ~
        (" â€¢ TMDb" if has_tmdb else "")
      ) | tojson }},
      "icon_url": {{ (jellyfin_url ~ "/web/favicon.png") | tojson }}
    },

    "timestamp": {{ timestamp | tojson }}
  ]
}
