{#
  ModÃ¨le d'Ã‰lÃ©ments Mis Ã  Jour GroupÃ©s pour Jellynouncer
  ==============================================================

  Notification de mise Ã  jour groupÃ©e complÃ¨te par type.
  Affiche tous les Ã©lÃ©ments mis Ã  jour organisÃ©s par catÃ©gorie avec changements.

  Prend en charge : Films, TV, Musique, Autre
#}
{
  "embeds": [
    {
      "title": {{ ("â¬†ï¸ " ~ (total_items | string) ~ " Ã‰lÃ©ments Mis Ã  Jour dans Jellyfin") | tojson }},

      "description": "Un rÃ©sumÃ© de tout le contenu mis Ã  jour organisÃ© par type :",

      "color": {{ color }},

      "fields": [
        {% set field_count = namespace(value=0) %}

        {#
          CatÃ©gorie Films avec Mises Ã  jour
          ------------------------------------
        #}
        {% if 'movies' in categories and categories.movies.upgraded|length > 0 %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "ðŸŽ¬ Films Mis Ã  Jour ({{ categories.movies.upgraded|length }})",
          "value": "{% for item_data in categories.movies.upgraded[:5] -%}
            **{{ item_data.item.name }}**
            {%- if item_data.item.year %} ({{ item_data.item.year }}){% endif %}
            {%- if item_data.changes and item_data.changes|length > 0 %}\nðŸ”„ {{ item_data.changes[0].old_value }} â†’ **{{ item_data.changes[0].new_value }}**
              {%- if item_data.changes|length > 1 %} (+{{ item_data.changes|length - 1 }}){% endif -%}
            {%- endif -%}
            {%- if item_data.item.video_height %}\nðŸ“ Maintenant : {{ item_data.item.video_height }}p
              {%- if item_data.item.video_range and item_data.item.video_range != 'SDR' %} {{ item_data.item.video_range }}{% endif -%}
            {%- endif -%}
            {%- set rating_parts = [] -%}
            {%- if item_data.item.omdb and item_data.item.omdb.imdb_rating and item_data.item.omdb.imdb_rating != 'N/A' -%}
              {%- set _ = rating_parts.append('IMDb: ' ~ item_data.item.omdb.imdb_rating) -%}
            {%- endif -%}
            {%- if item_data.item.tmdb and item_data.item.tmdb.rating_display -%}
              {%- set _ = rating_parts.append('TMDb: ' ~ item_data.item.tmdb.rating_display ~ '/10') -%}
            {%- endif -%}
            {%- if rating_parts|length > 0 %}\nâ­ {{ rating_parts | join(' â€¢ ') }}{% endif -%}
            {%- if not loop.last %}\n\n{% endif -%}
          {%- endfor -%}
          {%- if categories.movies.upgraded|length > 5 %}\n\n...et {{ categories.movies.upgraded|length - 5 }} de plus{% endif %}",
          "inline": false
        }
        {% endif %}

        {#
          CatÃ©gorie TV avec Mises Ã  jour
          ----------------------------------
        #}
        {% if 'tv' in categories and categories.tv.upgraded|length > 0 %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "ðŸ“º Contenu TV Mis Ã  Jour ({{ categories.tv.upgraded|length }})",
          "value": "{% for item_data in categories.tv.upgraded[:5] -%}
            {%- if item_data.item.item_type == 'Episode' -%}
              **{{ item_data.item.series_name }}** S{{ '%02d'|format(item_data.item.season_number or 0) }}E{{ '%02d'|format(item_data.item.episode_number or 0) }}
            {%- else -%}
              **{{ item_data.item.name }}**
            {%- endif %}
            {%- if item_data.changes and item_data.changes|length > 0 %}\nðŸ”„ {{ item_data.changes[0].old_value }} â†’ **{{ item_data.changes[0].new_value }}**{% endif -%}
            {%- if item_data.item.video_height %}\nðŸ“ Maintenant : {{ item_data.item.video_height }}p{% endif -%}
            {%- if item_data.item.tvdb and item_data.item.tvdb.rating %}\nâ­ TVDb: {{ item_data.item.tvdb.rating }}{% endif -%}
            {%- if not loop.last %}\n\n{% endif -%}
          {%- endfor -%}
          {%- if categories.tv.upgraded|length > 5 %}\n\n...et {{ categories.tv.upgraded|length - 5 }} de plus{% endif %}",
          "inline": false
        }
        {% endif %}

        {#
          CatÃ©gorie Musique avec Mises Ã  jour
          -------------------------------------
        #}
        {% if 'music' in categories and categories.music.upgraded|length > 0 %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "ðŸŽµ Musique Mise Ã  Jour ({{ categories.music.upgraded|length }})",
          "value": "{% for item_data in categories.music.upgraded[:6] -%}
            **{{ item_data.item.name }}**
            {%- if item_data.item.artists %} - {{ item_data.item.artists[0] }}{% endif -%}
            {%- if item_data.changes and item_data.changes|length > 0 %}\nðŸ”„ {{ item_data.changes[0].old_value }} â†’ **{{ item_data.changes[0].new_value }}**{% endif -%}
            {%- if not loop.last %}\n{% endif -%}
          {%- endfor -%}
          {%- if categories.music.upgraded|length > 6 %}\n...et {{ categories.music.upgraded|length - 6 }} de plus{% endif %}",
          "inline": false
        }
        {% endif %}

        {#
          Autre CatÃ©gorie avec Mises Ã  jour
          -----------------------------------
        #}
        {% if 'other' in categories and categories.other.upgraded|length > 0 %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "ðŸ“ Autre Mis Ã  Jour ({{ categories.other.upgraded|length }})",
          "value": "{% for item_data in categories.other.upgraded[:6] -%}
            **{{ item_data.item.name }}** ({{ item_data.item.item_type }})
            {%- if item_data.changes and item_data.changes|length > 0 %}\nðŸ”„ Mis Ã  jour{% endif -%}
            {%- if not loop.last %}\n{% endif -%}
          {%- endfor -%}
          {%- if categories.other.upgraded|length > 6 %}\n...et {{ categories.other.upgraded|length - 6 }} de plus{% endif %}",
          "inline": false
        }
        {% endif %}

        {#
          Statistiques de RÃ©sumÃ© des Mises Ã  Jour
          --------------------------------------------
        #}
        {% if field_count.value > 0 %},{% endif %}
        {
          "name": "ðŸ“Š RÃ©sumÃ© des Mises Ã  Jour",
          "value": "**Total des Mises Ã  Jour :** {{ total_items }}
            {%- if 'movies' in categories %}\nðŸŽ¬ Films : {{ categories.movies.upgraded|length }}{% endif -%}
            {%- if 'tv' in categories %}\nðŸ“º TV: {{ categories.tv.upgraded|length }}{% endif -%}
            {%- if 'music' in categories %}\nðŸŽµ Musique : {{ categories.music.upgraded|length }}{% endif -%}
            {%- if 'other' in categories %}\nðŸ“ Autre : {{ categories.other.upgraded|length }}{% endif -%}
            \n\n**Mises Ã  Jour les Plus FrÃ©quentes :**
            {%- set all_changes = [] -%}
            {%- for category in categories.values() -%}
              {%- for item_data in category.upgraded -%}
                {%- for change in item_data.changes -%}
                  {%- set _ = all_changes.append(change.type) -%}
                {%- endfor -%}
              {%- endfor -%}
            {%- endfor -%}
            {%- if 'resolution' in all_changes %}\nðŸ“ Mises Ã  jour de rÃ©solution{% endif -%}
            {%- if 'codec' in all_changes %}\nðŸŽžï¸ Mises Ã  jour de codec vidÃ©o{% endif -%}
            {%- if 'audio_codec' in all_changes %}\nðŸ”Š Mises Ã  jour audio{% endif -%}
            {%- if 'hdr_status' in all_changes %}\nðŸŒˆ Mises Ã  jour HDR{% endif %}",
          "inline": false
        }
      ],

      "footer": {
        "text": "Jellyfin
          {%- if upgraded_items and upgraded_items[0].item.server_name %} â€¢ {{ upgraded_items[0].item.server_name }}{% endif %}
          {%- set has_omdb = upgraded_items | selectattr('item.omdb') | list | length > 0 if upgraded_items else false -%}
          {%- set has_tvdb = upgraded_items | selectattr('item.tvdb') | list | length > 0 if upgraded_items else false -%}
          {%- set has_tmdb = upgraded_items | selectattr('item.tmdb') | list | length > 0 if upgraded_items else false -%}
          {%- if has_omdb %} â€¢ IMDb via OMDb{% endif -%}
          {%- if has_tvdb %} â€¢ TheTVDB{% endif -%}
          {%- if has_tmdb %} â€¢ TMDb{% endif %}",
        "icon_url": {{ (jellyfin_url ~ "/web/favicon.ico") | tojson }}
      },

      "timestamp": {{ timestamp | tojson }}
    }
  ]
}
