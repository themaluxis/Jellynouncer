{#
  Mod√®le de statut du serveur pour Jellynouncer
  =============================================

  Fournit des notifications compl√®tes de statut de serveur avec m√©triques de sant√©.
  Prend en charge les √©tats en ligne/hors ligne, performances d√©grad√©es et informations de r√©cup√©ration.

  Variables:
  - is_online: Bool√©en pour la connectivit√© du serveur
  - jellyfin_url: URL du serveur
  - timestamp: Horodatage ISO
  - server_info: D√©tails optionnels du serveur (quand en ligne)
  - health_data: Donn√©es optionnelles de v√©rification de sant√©
  - downtime_duration: Dur√©e optionnelle d'arr√™t du serveur
  - error_details: Informations optionnelles d'erreur
#}
{
  "embeds": [
    {
      {#
        Titre dynamique bas√© sur le statut
        -----------------------------------
        Prend en charge plus d'√©tats que simplement en ligne/hors ligne
      #}
      "title": {{ (
        ("üü° Serveur Jellyfin d√©grad√©" if health_data and health_data.status == 'degraded'
         else "üü¢ Serveur Jellyfin en ligne") if is_online
        else "üî¥ Serveur Jellyfin hors ligne"
      ) | tojson }},

      {#
        Description am√©lior√©e avec contexte
        ------------------------------------
        Fournit des informations de statut plus d√©taill√©es
      #}
      "description": "{% if is_online -%}
        {%- if health_data and health_data.status == 'degraded' -%}
          ‚ö†Ô∏è **Le serveur Jellyfin rencontre des probl√®mes mais reste partiellement op√©rationnel.**\n\n
          üîç **D√©tails du probl√®me**: Certains composants peuvent ne pas fonctionner correctement\n
          üìä **Statut g√©n√©ral**: Performances d√©grad√©es\n
          üîÑ **Notifications**: Peuvent √™tre retard√©es ou incompl√®tes
        {%- elif downtime_duration -%}
          üéâ **La connexion au serveur Jellyfin a √©t√© restaur√©e !**\n\n
          ‚è±Ô∏è **Dur√©e d'arr√™t**: {{ downtime_duration }}\n
          üìä **Statut du service**: Tous les syst√®mes op√©rationnels\n
          üîÑ **Actions de r√©cup√©ration**: Synchronisation des √©l√©ments manqu√©s\n
          üì∫ **Acc√®s aux m√©dias**: Enti√®rement disponible
        {%- else -%}
          ‚úÖ **Le serveur Jellyfin fonctionne normalement.**\n\n
          üìä **Statut du service**: Tous les syst√®mes op√©rationnels\n
          üîÑ **Notifications**: Actives et en cours de traitement\n
          üì∫ **Acc√®s aux m√©dias**: Disponible
        {%- endif -%}
      {%- else -%}
        ‚ö†Ô∏è **Impossible de se connecter au serveur Jellyfin.**\n\n
        üîç **Statut**: Connexion perdue
        {%- if error_details %}\n‚ùå **Erreur**: {{ error_details }}{% endif -%}
        \n‚è∞ **Intervalle de retry**: Toutes les 60 secondes\n
        üì± **Notifications**: Mises en file d'attente jusqu'√† la reconnexion\n
        üíæ **Donn√©es**: Toutes les notifications seront trait√©es lors de la restauration de connexion
      {%- endif %}",

      {#
        Couleur dynamique bas√©e sur le statut
        --------------------------------------
      #}
      "color": {% if is_online -%}
        {%- if health_data and health_data.status == 'degraded' -%}
          16776960
        {%- else -%}
          65280
        {%- endif -%}
      {%- else -%}
        16711680
      {%- endif %},

      "fields": [
        {#
          D√©tails de connexion au serveur
          --------------------------------
        #}
        {
          "name": "üåê D√©tails du serveur :",
          "value": {{ ("**URL**: " ~ jellyfin_url ~ "\n**Statut**: " ~
            ("‚ö†Ô∏è D√©grad√©" if is_online and health_data and health_data.status == 'degraded'
             else "‚úÖ Connect√©" if is_online
             else "‚ùå D√©connect√©") ~
            ("\n**Serveur**: " ~ server_info.ServerName if server_info and server_info.ServerName else "") ~
            ("\n**Version**: " ~ server_info.Version if server_info and server_info.Version else "")
          ) | tojson }},
          "inline": true
        },

        {#
          Horodatage avec meilleur formatage
          ----------------------------------
        #}
        {
          "name": "üïê Horodatage :",
          "value": {{ ((timestamp[:19] | replace('T', ' ')) ~ " UTC" ~
            ("\n**Temps d'arr√™t**: " ~ downtime_duration if downtime_duration else "")
          ) | tojson }},
          "inline": true
        }

        {#
          Statut des composants de service (quand en ligne)
          --------------------------------------------------
        #}
        {% if is_online and health_data and health_data.components %}
        ,{
          "name": "üìä Statut des composants :",
          "value": "
            {%- if health_data.components.jellyfin -%}
              **Jellyfin**:
              {%- if health_data.components.jellyfin.status == 'healthy' %} ‚úÖ Sain
              {%- elif health_data.components.jellyfin.status == 'degraded' %} ‚ö†Ô∏è D√©grad√©
              {%- else %} ‚ùå D√©faillant{% endif -%}
            {%- endif -%}
            {%- if health_data.components.database -%}
              \n**Base de donn√©es**:
              {%- if health_data.components.database.status == 'healthy' %} ‚úÖ Saine
              {%- else %} ‚ùå Probl√®mes{% endif -%}
              {%- if health_data.components.database.total_items %} ({{ health_data.components.database.total_items }} √©l√©ments){% endif -%}
            {%- endif -%}
            {%- if health_data.components.discord -%}
              \n**Discord**:
              {%- if health_data.components.discord.webhooks_configured %} ‚úÖ {{ health_data.components.discord.webhooks_configured }} webhooks
              {%- else %} ‚ùå Aucun webhook{% endif -%}
            {%- endif -%}
            {%- if health_data.components.metadata_services -%}
              \n**M√©tadonn√©es**:
              {%- if health_data.components.metadata_services.enabled %} ‚úÖ Activ√©es
              {%- else %} ‚ö†Ô∏è D√©sactiv√©es{% endif -%}
            {%- endif %}",
          "inline": false
        }
        {% endif %}

        {#
          Statistiques de service (quand en ligne)
          -----------------------------------------
        #}
        {% if is_online and health_data and health_data.service_status %}
        ,{
          "name": "üìà M√©triques du service :",
          "value": "
            {%- if health_data.service_status.uptime_seconds -%}
              **Temps de fonctionnement**: {{ (health_data.service_status.uptime_seconds / 3600) | round(1) }} heures
            {%- endif -%}
            {%- if health_data.service_status.initial_sync_complete is defined -%}
              \n**Synchronisation initiale**:
              {%- if health_data.service_status.initial_sync_complete %} ‚úÖ Termin√©e
              {%- else %} ‚è≥ En cours{% endif -%}
            {%- endif -%}
            {%- if health_data.service_status.sync_in_progress is defined -%}
              \n**Synchronisation en arri√®re-plan**:
              {%- if health_data.service_status.sync_in_progress %} üîÑ En cours
              {%- else %} ‚è∏Ô∏è Inactive{% endif -%}
            {%- endif %}",
          "inline": true
        }
        {% endif %}

        {#
          Statut de file d'attente (quand disponible)
          --------------------------------------------
        #}
        {% if queue_status %}
        ,{
          "name": "üì¨ Files de notifications :",
          "value": "
            {%- if queue_status.new_items is defined -%}
              **Nouveaux √©l√©ments**: {{ queue_status.new_items }} en file
            {%- endif -%}
            {%- if queue_status.upgraded_items is defined -%}
              \n**Mises √† niveau**: {{ queue_status.upgraded_items }} en file
            {%- endif -%}
            {%- if queue_status.total is defined -%}
              \n**Total en attente**: {{ queue_status.total }}
            {%- endif %}",
          "inline": true
        }
        {% endif %}

        {#
          Prochaines √©tapes / Actions
          ----------------------------
        #}
        {% if is_online %}
        ,{
          "name": "üîÑ {% if downtime_duration %}Actions de r√©cup√©ration{% else %}Actions syst√®me{% endif %}",
          "value": "
            {%- if downtime_duration -%}
              ‚Ä¢ Traitement des notifications en file d'attente\n
              ‚Ä¢ Synchronisation des changements de biblioth√®que\n
              ‚Ä¢ V√©rification de l'int√©grit√© de la base de donn√©es\n
              ‚Ä¢ Reprise de la surveillance normale
            {%- elif health_data and health_data.status == 'degraded' -%}
              ‚Ä¢ Surveillance des composants d√©grad√©s\n
              ‚Ä¢ Tentative de r√©cup√©ration automatique\n
              ‚Ä¢ Enregistrement des informations de diagnostic\n
              ‚Ä¢ Possible nouvelle tentative d'op√©rations √©chou√©es
            {%- else -%}
              ‚Ä¢ Surveillance du nouveau contenu\n
              ‚Ä¢ Traitement normal des webhooks\n
              ‚Ä¢ Synchronisation en arri√®re-plan active\n
              ‚Ä¢ Tous les syst√®mes op√©rationnels
            {%- endif %}",
          "inline": false
        }
        {% else %}
        ,{
          "name": "üìã R√©cup√©ration automatique :",
          "value": "‚Ä¢ Tentative de reconnexion toutes les 60 secondes\n
            ‚Ä¢ Pr√©servation de la file de notifications\n
            ‚Ä¢ Surveillance de la disponibilit√© du serveur\n
            ‚Ä¢ Synchronisation automatique lors de la restauration\n
            ‚Ä¢ Aucune donn√©e ne sera perdue",
          "inline": false
        }
        {% endif %}

        {#
          D√©tails d'erreur (quand hors ligne)
          ------------------------------------
        #}
        {% if not is_online and error_details %}
        ,{
          "name": "‚ùå Informations d'erreur :",
          "value": {{ ("**Type**: " ~ (error_type | default('Erreur de connexion')) ~ "\n" ~
            "**D√©tails**: " ~ ((error_details[:500] + '...') if error_details|length > 500 else error_details) ~ "\n" ~
            "**Heure**: " ~ (timestamp[:19] | replace('T', ' '))
          ) | tojson }},
          "inline": false
        }
        {% endif %}
      ],

      {#
        Miniature dynamique
        -------------------
      #}
      "thumbnail": {
        "url": {{ (
          (jellyfin_url ~ "/web/favicon.png" if health_data and health_data.status == 'degraded'
           else jellyfin_url ~ "/web/assets/img/banner-light.png") if is_online
          else jellyfin_url ~ "/web/favicon.png"
        ) | tojson }}
      },

      {#
        Pied de page am√©lior√©
        ---------------------
      #}
      "footer": {
        "text": {{ ("Jellynouncer v2.0.0 ‚Ä¢ Service de surveillance" ~
          (" ‚Ä¢ " ~ server_info.ServerName if server_info and server_info.ServerName else "") ~
          (" ‚Ä¢ M√©tadonn√©es activ√©es" if is_online and health_data and health_data.components.metadata_services and health_data.components.metadata_services.enabled else "")
        ) | tojson }},
        "icon_url": {{ (jellyfin_url ~ "/web/favicon.png") | tojson }}
      },

      "timestamp": {{ timestamp | tojson }}
    }
  ]
}