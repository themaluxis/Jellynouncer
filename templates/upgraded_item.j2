{#
  Mod√®le Jinja2 Discord Webhook d'√âl√©ment Mis √† Jour pour Jellynouncer
  ======================================================================

  Ce mod√®le g√©n√®re des messages embed Discord pour les √©l√©ments m√©dias mis √† jour.
  Affiche ce qui a chang√© et inclut des m√©tadonn√©es enrichies de plusieurs sources.

  Priorit√© des Sources de M√©tadonn√©es :
  ------------------------------------
  - S√©ries TV/√âpisodes : TVDb ‚Üí Propri√©t√©s de base Jellyfin
  - Films : TMDb ‚Üí OMDb ‚Üí Propri√©t√©s de base Jellyfin

  Types de Changements Support√©s :
  --------------------------------
  - resolution : Mise √† jour de la r√©solution vid√©o
  - codec : Changement de codec vid√©o
  - audio_codec : Mise √† jour du codec audio
  - audio_channels : Mise √† jour de la configuration des canaux
  - hdr_status : Mise √† jour HDR
  - file_size : Remplacement de fichier
#}
{
  "embeds": [
    {
      {#
        Titre Dynamique avec Type de Mise √† Jour
        -------------------------------------------
        Affiche le type de mise √† jour sp√©cifique quand un seul changement s'est produit
      #}
      "title": {{ ("‚¨ÜÔ∏è" ~ 
        ("üì∫ " ~ (item.name | default('√âpisode Inconnu') | truncate(180, True, '...')) if item.item_type == 'Episode' else
         "üì∫ " ~ (item.name | default('S√©rie Inconnue') | truncate(180, True, '...')) if item.item_type == 'Series' else
         "üé¨ " ~ (item.name | default('Film Inconnu') | truncate(180, True, '...')) if item.item_type == 'Movie' else
         "üì∫ " ~ (item.series_name | default('S√©rie Inconnue')) ~ " - Saison " ~ (item.season_number | default('?') | string) if item.item_type == 'Season' else
         "üéµ " ~ (item.name | default('Chanson Inconnue') | truncate(180, True, '...')) if item.item_type == 'Audio' else
         "üíø " ~ (item.name | default('Album Inconnu') | truncate(180, True, '...')) if item.item_type == 'MusicAlbum' else
         "üé§ " ~ (item.name | default('Artiste Inconnu') | truncate(180, True, '...')) if item.item_type == 'MusicArtist' else
         "üì∑ " ~ (item.name | default('Photo') | truncate(180, True, '...')) if item.item_type == 'Photo' else
         "üìÅ " ~ (item.name | default(item.item_type ~ ' Inconnu') | truncate(180, True, '...'))
        ) ~ " " ~ (changes[0].type|title ~ " " if changes|length == 1 else "") ~ "Mis √† Jour") | tojson }},

      {#
        Description Riche avec Priorit√© des M√©tadonn√©es
        ---------------------------------------------------
        M√™me priorit√© de source de m√©tadonn√©es que le mod√®le new_item
      #}
      "description": {{ (
        ("**" ~ (item.series_name | default('S√©rie Inconnue')) ~ "**\n" ~
         "S" ~ ("%02d" % (item.season_number | default(0))) ~ "E" ~ ("%02d" % (item.episode_number | default(0))) ~ "\n" ~
         (item.name | default('√âpisode Inconnu')) ~
         ("\n\n" ~ ((item.tvdb.overview[:200] + '...') if item.tvdb.overview | length > 200 else item.tvdb.overview) if item.tvdb and item.tvdb.overview and item.tvdb.overview | length > 0
          else "\n\n" ~ ((item.overview[:200] + '...') if item.overview | length > 200 else item.overview) if item.overview and item.overview | length > 0
          else "")
        ) if item.item_type == 'Episode' else
        ("**" ~ (item.name | default('Titre Inconnu')) ~ "**" ~
         (" (" ~ item.year ~ ")" if item.year else "") ~
         ("\n\n" ~ ((item.tvdb.overview[:200] + '...') if item.tvdb.overview | length > 200 else item.tvdb.overview) if item.tvdb and item.tvdb.overview and item.tvdb.overview | length > 0
          else "\n\n" ~ ((item.overview[:200] + '...') if item.overview | length > 200 else item.overview) if item.overview and item.overview | length > 0
          else "")
        ) if item.item_type in ['Series', 'Season'] else
        ("**" ~ (item.name | default('Titre Inconnu')) ~ "**" ~
         (" (" ~ item.year ~ ")" if item.year else "") ~
         ("\n\n" ~ ((item.tmdb.overview[:200] + '...') if item.tmdb.overview | length > 200 else item.tmdb.overview) if item.tmdb and item.tmdb.overview and item.tmdb.overview | length > 0
          else "\n\n" ~ ((item.omdb.plot[:200] + '...') if item.omdb.plot | length > 200 else item.omdb.plot) if item.omdb and item.omdb.plot and item.omdb.plot != 'N/A'
          else "\n\n" ~ ((item.overview[:200] + '...') if item.overview | length > 200 else item.overview) if item.overview and item.overview | length > 0
          else "")
        ) if item.item_type == 'Movie' else
        ("**" ~ (item.name | default('Titre Inconnu')) ~ "**" ~
         ("\n\n" ~ ((item.overview[:200] + '...') if item.overview | length > 200 else item.overview) if item.overview and item.overview | length > 0 else "")
        )
      ) | tojson }},

      "color": {{ color }},

      "fields": [
        {%- set fields_added = namespace(count=0) -%}

        {#
          Affichage des Changements de Mise √† Jour
          -------------------------------------------
          Montre ce qui a √©t√© mis √† jour avec le format avant ‚Üí apr√®s
        #}
        {% if changes and changes | length > 0 %}
          {% for change in changes[:3] %}
            {% if fields_added.count > 0 %},{% endif %}
            {% set fields_added.count = fields_added.count + 1 %}
          {
            "name": "{% if change.type == 'resolution' -%}
              üìê Mise √† Jour R√©solution
            {%- elif change.type == 'codec' -%}
              üéûÔ∏è Mise √† Jour Codec Vid√©o
            {%- elif change.type == 'audio_codec' -%}
              üîä Mise √† Jour Codec Audio
            {%- elif change.type == 'audio_channels' -%}
              üîä Mise √† Jour Canaux
            {%- elif change.type == 'hdr_status' -%}
              üåà Mise √† Jour HDR
            {%- elif change.type == 'file_size' -%}
              üíæ Fichier Remplac√©
            {%- else -%}
              üîÑ {{ change.type | title }}
            {%- endif %}",
            "value": {{ ((change.old_value or 'Inconnu') ~ " ‚Üí **" ~ (change.new_value or 'Inconnu') ~ "**") | tojson }},
            "inline": true
          }
          {% endfor %}
          {% if changes | length > 3 and fields_added.count < 24 %}
            {% if fields_added.count > 0 %},{% endif %}
            {% set fields_added.count = fields_added.count + 1 %}
          {
            "name": "‚ûï Changements Suppl√©mentaires",
            "value": {{ ("+" ~ ((changes | length - 3) | string) ~ " mises √† jour suppl√©mentaires") | tojson }},
            "inline": true
          }
          {% endif %}
        {% endif %}

        {#
          Sp√©cifications Techniques Actuelles
          ------------------------------------
          Affiche les nouvelles sp√©cifications actuelles apr√®s mise √† jour
        #}
        {% if item.video_height and item.item_type not in ['Audio', 'MusicAlbum', 'MusicArtist'] and fields_added.count < 24 %}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "üìê Qualit√© Actuelle",
          "value": {{ ((item.video_height | string) ~ "p" ~
            (" " ~ item.video_range if item.video_range and item.video_range != 'SDR' else "")
          ) | tojson }},
          "inline": true
        }
        {% endif %}

        {% if item.video_codec and item.item_type not in ['Audio', 'MusicAlbum', 'MusicArtist'] and fields_added.count < 24 %}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "üéûÔ∏è Vid√©o",
          "value": {{ ((item.video_codec | upper) ~
            (" " ~ item.video_profile if item.video_profile else "")
          ) | tojson }},
          "inline": true
        }
        {% endif %}

        {% if item.audio_codec and fields_added.count < 24 %}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "üîä Audio",
          "value": {{ ((item.audio_codec | upper) ~
            (" Stereo" if item.audio_channels == 2
             else " 5.1" if item.audio_channels == 6
             else " 7.1" if item.audio_channels == 8
             else " " ~ (item.audio_channels | string) ~ "ch" if item.audio_channels
             else "")
          ) | tojson }},
          "inline": true
        }
        {% endif %}

        {% if item.file_size and fields_added.count < 24 %}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "üíæ Nouvelle Taille",
          "value": {{ (("%.1f" % (item.file_size / 1073741824)) ~ " GB") | tojson }},
          "inline": true
        }
        {% endif %}

        {#
          Affichage des Notes en Ligne
          -----------------------------
          Toutes les notes sur une ligne s√©par√©es par des puces
        #}
        {% set has_ratings = false %}
        {% if (item.omdb and (item.omdb.imdb_rating or item.omdb.metascore or
               item.omdb.ratings_dict.rotten_tomatoes)) or
               (item.tmdb and item.tmdb.rating_display) or
               (item.tvdb and item.tvdb.rating) %}
          {% set has_ratings = true %}
        {% endif %}

        {% if has_ratings and fields_added.count < 24 %}
          {% if fields_added.count > 0 %},{% endif %}
          {% set fields_added.count = fields_added.count + 1 %}
        {
          "name": "‚≠ê Notes",
          "value": {{ (
            {%- set rating_parts = [] -%}
            {%- if item.omdb and item.omdb.imdb_rating and item.omdb.imdb_rating != 'N/A' -%}
              {%- set _ = rating_parts.append('**IMDb:** ' ~ item.omdb.imdb_rating) -%}
            {%- endif -%}
            {%- if item.omdb and item.omdb.ratings_dict.rotten_tomatoes -%}
              {%- set _ = rating_parts.append('**RT:** ' ~ item.omdb.ratings_dict.rotten_tomatoes.value) -%}
            {%- endif -%}
            {%- if item.omdb and item.omdb.metascore and item.omdb.metascore != 'N/A' -%}
              {%- set _ = rating_parts.append('**MC:** ' ~ item.omdb.metascore) -%}
            {%- endif -%}
            {%- if item.tmdb and item.tmdb.rating_display -%}
              {%- set _ = rating_parts.append('**TMDb:** ' ~ item.tmdb.rating_display) -%}
            {%- elif item.omdb and item.omdb.ratings_dict.tmdb -%}
              {%- set _ = rating_parts.append('**TMDb:** ' ~ item.omdb.ratings_dict.tmdb.value) -%}
            {%- endif -%}
            {%- if item.tvdb and item.tvdb.rating -%}
              {%- set _ = rating_parts.append('**TVDb:** ' ~ item.tvdb.rating) -%}
            {%- endif -%}
            rating_parts | join(' ‚Ä¢ ')
          ) | tojson }},
          "inline": false
        }
        {% endif %}
      ],

      {# S√©lection d'image avec priorit√© #}
      {% if item.item_type == 'Episode' and item.series_id %}
      "thumbnail": {
        "url": {{ thumbnail_url | tojson }}
      },
      {% elif item.item_id %}
      "thumbnail": {
        "url": {{ thumbnail_url | tojson }}
      },
      {% elif item.omdb and item.omdb.poster and item.omdb.poster != 'N/A' %}
      "thumbnail": {
        "url": {{ item.omdb.poster | tojson }}
      },
      {% elif item.tvdb and item.tvdb.poster_url %}
      "thumbnail": {
        "url": {{ item.tvdb.poster_url | tojson }}
      },
      {% elif item.tmdb and item.tmdb.backdrop_url %}
      "image": {
        "url": {{ item.tmdb.backdrop_url | tojson }}
      },
      {% endif %}

      "footer": {
        "text": {{ ((item.library_name or 'Jellyfin') ~
          (" ‚Ä¢ " ~ item.server_name if item.server_name else "") ~
          (" ‚Ä¢ IMDb via OMDb" if item.omdb else "") ~
          (" ‚Ä¢ TheTVDB" if item.tvdb else "") ~
          (" ‚Ä¢ TMDb" if item.tmdb else "")
        ) | tojson }},
        "icon_url": {{ (jellyfin_url ~ "/web/favicon.png") | tojson }}
      },

      {% if item.item_id %}
      "url": {{ (jellyfin_url ~ "/web/index.html#!/details?id=" ~ item.item_id) | tojson }},
      {% endif %}

      "timestamp": {{ timestamp | tojson }}
    }
  ]
}
