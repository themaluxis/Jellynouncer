{#
  Upgraded Item Jinja2 Discord Webhook Template for Jellynouncer
  ===============================================================

  This template generates Discord embed messages for upgraded media items.
  Shows what changed and includes enriched metadata from multiple sources.

  Metadata Source Priority:
  ------------------------
  - TV Shows/Episodes: TVDb → Jellyfin base properties
  - Movies: TMDb → OMDb → Jellyfin base properties

  Change Types Supported:
  ----------------------
  - resolution: Video resolution upgrade
  - codec: Video codec change
  - audio_codec: Audio codec upgrade
  - audio_channels: Channel configuration upgrade
  - hdr_status: HDR upgrade
  - file_size: File replacement
#}
{
  "embeds": [
    {
      {#
        Dynamic Title Based on Item Type (Translated to French)
      #}
      "title": {{ ("⬆️" ~
        (" mise à jour : " ~ (item.series_name | default('Série Inconnue')) ~ " - " ~ (item.name | default('Épisode Inconnu'))) if item.item_type == 'Episode' else
        (" mise à jour : " ~ (item.name | default('Série Inconnue'))) if item.item_type == 'Series' else
        (" mise à jour : " ~ (item.name | default('Film Inconnu'))) if item.item_type == 'Movie' else
        (" mise à jour : " ~ (item.series_name | default('Série Inconnue')) ~ " - Saison " ~ (item.season_number | string | default('?'))) if item.item_type == 'Season' else
        (" mise à jour : " ~ (item.name | default('Contenu Inconnu')))
      ) | tojson }},

      {#
        Rich Description with Metadata Priority
      #}
      {% set desc = item.overview or (item.get('tmdb') and item.get('tmdb').get('overview')) or (item.get('omdb') and item.get('omdb').get('plot')) or '' %}
      "description": {{ ("**" ~ (item.name | default('Titre Inconnu')) ~ "**" ~ (" (" ~ item.year ~ ")" if item.year else "") ~ "\n\n" ~ desc[:400] ~ ('...' if desc | length > 400 else '')) | tojson }},

      "color": {{ color }},

      {#
        Build a list of fields dynamically to avoid comma issues.
      #}
      {% set fields = [] %}

      {# Upgrade Changes Display #}
      {% if changes %}
        {% set change_descs = changes | map(attribute='description') | list %}
        {% set _ = fields.append({
          "name": "Changements (" ~ changes | length ~ ")",
          "value": (change_descs | join('\n')),
          "inline": false
        }) %}
      {% endif %}

      {# New Technical Specifications #}
      {% if item.video_height %}
        {% set _ = fields.append({
          "name": "Nouvelle Qualité",
          "value": "`" ~ item.video_height ~ "p" ~ (" " ~ item.video_range if item.video_range and item.video_range != 'SDR' else "") ~ "`",
          "inline": true
        }) %}
      {% endif %}

      {% if item.video_codec %}
        {% set _ = fields.append({
          "name": "Nouveau Vidéo",
          "value": "`" ~ (item.video_codec | upper) ~ "`",
          "inline": true
        }) %}
      {% endif %}

      {% if item.audio_codec %}
        {% set _ = fields.append({
          "name": "Nouveau Audio",
          "value": "`" ~ (item.audio_codec | upper) ~ (" " ~ item.audio_channels ~ "ch" if item.audio_channels else "") ~ "`",
          "inline": true
        }) %}
      {% endif %}

      {# Ratings and Links #}
      {% set rating_parts = [] %}
      {% if item.imdb_id %}
          {% set _ = rating_parts.append('[IMDb](https://www.imdb.com/title/' ~ item.imdb_id ~ ')') %}
      {% endif %}
      {% if item.tmdb_id and item.item_type in ['Movie', 'Series'] %}
          {% set _ = rating_parts.append('[TMDb](https://www.themoviedb.org/' ~ ('movie' if item.item_type == 'Movie' else 'tv') ~ '/' ~ item.tmdb_id ~ ')') %}
      {% endif %}
      {% if item.ratings and item.ratings.imdb %}
          {% set _ = rating_parts.append('**IMDb:** ' ~ item.ratings.imdb.value) %}
      {% endif %}
      {% if item.ratings and item.ratings.tmdb %}
          {% set _ = rating_parts.append('**TMDb:** ' ~ item.ratings.tmdb.value) %}
      {% endif %}

      {% if rating_parts %}
        {% set _ = fields.append({
          "name": "Notes et Liens",
          "value": (rating_parts | join(' • ')),
          "inline": false
        }) %}
      {% endif %}

      "fields": {{ fields | tojson }},

      {# Image #}
      {% if thumbnail_url %}
      "thumbnail": {
        "url": {{ thumbnail_url | tojson }}
      },
      {% endif %}

      {# Footer #}
      "footer": {
        "text": {{ ((item.library_name or 'Jellyfin') ~ (' • ' ~ item.server_name if item.server_name else '')) | tojson }},
        "icon_url": {{ (jellyfin_url ~ "/web/favicon.png") | tojson }}
      },

      {% if item.item_id %}
      "url": {{ (jellyfin_url ~ "/web/index.html#!/details?id=" ~ item.item_id) | tojson }},
      {% endif %}

      "timestamp": {{ timestamp | tojson }}
    }
  ]
}
