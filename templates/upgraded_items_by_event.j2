{#
  ModÃ¨le d'Ã‰lÃ©ments Mis Ã  Jour par Ã‰vÃ©nement pour Jellynouncer
  ===================================================================

  Regroupe plusieurs Ã©lÃ©ments mis Ã  jour en une seule notification.
  Affiche les changements de mise Ã  jour pour chaque Ã©lÃ©ment avec mÃ©tadonnÃ©es.

  OptimisÃ© pour : Plusieurs mises Ã  jour simultanÃ©es
#}
{
  "embeds": [
    {
      "title": {{ ("â¬†ï¸ " ~ (total_items | string) ~ " Ã‰lÃ©ments Mis Ã  Jour") | tojson }},

      "description": "Les Ã©lÃ©ments suivants ont Ã©tÃ© mis Ã  jour dans Jellyfin :",

      "color": {{ color }},

      "fields": [
        {% set field_count = namespace(value=0) %}

        {#
          Traiter chaque Ã©lÃ©ment mis Ã  jour
          --------------------------------------
          Afficher le nom de l'Ã©lÃ©ment et le changement principal
        #}
        {% for item_data in upgraded_items[:20] %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "{{ item_data.item.item_type }}: {{ (item_data.item.name[:200] + '...')
            if item_data.item.name|length > 200 else item_data.item.name }}",

          "value": "
            {%- if item_data.item.item_type == 'Episode' -%}
              {{ item_data.item.series_name }} S{{ '%02d'|format(item_data.item.season_number or 0) }}E{{ '%02d'|format(item_data.item.episode_number or 0) }}
            {%- endif -%}

            {%- if item_data.changes and item_data.changes|length > 0 -%}
              \nðŸ”„ **Mises Ã  jour :**
              {%- for change in item_data.changes[:2] %}
                \nâ€¢ {{ change.old_value or 'Inconnu' }} â†’ **{{ change.new_value or 'Inconnu' }}**
              {%- endfor -%}
              {%- if item_data.changes|length > 2 %} (+{{ item_data.changes|length - 2 }} de plus){% endif -%}
            {%- endif -%}

            {%- if item_data.item.video_height -%}
              \nðŸ“ Maintenant : {{ item_data.item.video_height }}p
              {%- if item_data.item.video_range and item_data.item.video_range != 'SDR' %} {{ item_data.item.video_range }}{% endif -%}
            {%- endif -%}

            {#
              Ajouter la note principale si disponible
            #}
            {%- if item_data.item.omdb and item_data.item.omdb.imdb_rating and item_data.item.omdb.imdb_rating != 'N/A' -%}
              \nâ­ IMDb: {{ item_data.item.omdb.imdb_rating }}
            {%- elif item_data.item.tmdb and item_data.item.tmdb.rating_display -%}
              \nâ­ TMDb: {{ item_data.item.tmdb.rating_display }}/10
            {%- elif item_data.item.tvdb and item_data.item.tvdb.rating -%}
              \nâ­ TVDb: {{ item_data.item.tvdb.rating }}
            {%- endif %}",

          "inline": true
        }
        {% endfor %}

        {% if upgraded_items|length > 20 %}
          {% if field_count.value > 0 %},{% endif %}
        {
          "name": "âž• Mises Ã  Jour SupplÃ©mentaires",
          "value": "Et {{ upgraded_items|length - 20 }} Ã©lÃ©ments mis Ã  jour de plus...",
          "inline": false
        }
        {% endif %}
      ],

      "footer": {
        "text": "Jellyfin
          {%- if upgraded_items[0].item.server_name %} â€¢ {{ upgraded_items[0].item.server_name }}{% endif %}
          {%- set has_omdb = upgraded_items | selectattr('item.omdb') | list | length > 0 -%}
          {%- set has_tvdb = upgraded_items | selectattr('item.tvdb') | list | length > 0 -%}
          {%- set has_tmdb = upgraded_items | selectattr('item.tmdb') | list | length > 0 -%}
          {%- if has_omdb %} â€¢ IMDb via OMDb{% endif -%}
          {%- if has_tvdb %} â€¢ TheTVDB{% endif -%}
          {%- if has_tmdb %} â€¢ TMDb{% endif %}",
        "icon_url": {{ (jellyfin_url ~ "/web/favicon.png") | tojson }}
      },

      "timestamp": {{ timestamp | tojson }}
    }
  ]
}
