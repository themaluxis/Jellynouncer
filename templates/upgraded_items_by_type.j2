{#
  ModÃ¨le d'Ã‰lÃ©ments Mis Ã  Jour par Type pour Jellynouncer
  ============================================================

  Regroupe les Ã©lÃ©ments mis Ã  jour par type de mÃ©dia avec enrichissement des mÃ©tadonnÃ©es.
  Affiche les changements de mise Ã  jour et la qualitÃ© actuelle avec les notes.

  CatÃ©gories : films, tv, musique, autre
#}
{
  "embeds": [
    {% if category == 'movies' %}
    {
      "title": "â¬†ï¸ Films Mis Ã  Jour ({{ total_items }})",
      "description": "Les films suivants ont Ã©tÃ© mis Ã  jour dans Jellyfin :",
      "color": {{ color }},

      "fields": [
        {% set field_count = namespace(value=0) %}

        {% for item_data in upgraded_items[:8] %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "ðŸŽ¬ {{ (item_data.item.name[:230] + '...') if item_data.item.name|length > 230 else item_data.item.name }}
            {%- if item_data.item.year %} ({{ item_data.item.year }}){% endif %}",

          "value": "
            {#
              Afficher les changements de mise Ã  jour
              -------------------------------------------
            #}
            {%- if item_data.changes and item_data.changes|length > 0 -%}
              **Mises Ã  jour :**
              {%- for change in item_data.changes[:2] %}
                \nâ€¢ {{ change.old_value or 'Inconnu' }} â†’ **{{ change.new_value or 'Inconnu' }}**
              {%- endfor -%}
              {%- if item_data.changes|length > 2 %} (+{{ item_data.changes|length - 2 }} de plus){% endif -%}
            {%- endif -%}

            {#
              SpÃ©cifications actuelles
              -------------------------
            #}
            {%- if item_data.item.video_height -%}
              \nðŸ“ Maintenant : {{ item_data.item.video_height }}p
              {%- if item_data.item.video_range and item_data.item.video_range != 'SDR' %} {{ item_data.item.video_range }}{% endif -%}
            {%- endif -%}

            {%- if item_data.item.video_codec -%}
              â€¢ ðŸŽžï¸ {{ item_data.item.video_codec|upper }}
            {%- endif -%}

            {%- if item_data.item.audio_codec -%}
              â€¢ ðŸ”Š {{ item_data.item.audio_codec|upper }}
            {%- endif -%}

            {#
              Notes en ligne pour les films
              ------------------------------
            #}
            {%- set rating_parts = [] -%}
            {%- if item_data.item.omdb and item_data.item.omdb.imdb_rating and item_data.item.omdb.imdb_rating != 'N/A' -%}
              {%- set _ = rating_parts.append('IMDb: ' ~ item_data.item.omdb.imdb_rating) -%}
            {%- endif -%}
            {%- if item_data.item.omdb and item_data.item.omdb.ratings_dict.rotten_tomatoes -%}
              {%- set _ = rating_parts.append('RT: ' ~ item_data.item.omdb.ratings_dict.rotten_tomatoes.value) -%}
            {%- endif -%}
            {%- if item_data.item.tmdb and item_data.item.tmdb.rating_display -%}
              {%- set _ = rating_parts.append('TMDb: ' ~ item_data.item.tmdb.rating_display ~ '/10') -%}
            {%- endif -%}
            {%- if rating_parts|length > 0 -%}
              \nâ­ {{ rating_parts | join(' â€¢ ') }}
            {%- endif %}",

          "inline": false
        }
        {% endfor %}

        {% if upgraded_items|length > 8 %}
          {% if field_count.value > 0 %},{% endif %}
        {
          "name": "âž• Mises Ã  Jour de Films SupplÃ©mentaires",
          "value": "Et {{ upgraded_items|length - 8 }} films mis Ã  jour de plus...",
          "inline": false
        }
        {% endif %}
      ]
    }

    {% elif category == 'tv' %}
    {
      "title": "â¬†ï¸ Contenu TV Mis Ã  Jour ({{ total_items }})",
      "description": "Le contenu TV suivant a Ã©tÃ© mis Ã  jour dans Jellyfin :",
      "color": {{ color }},

      "fields": [
        {% set field_count = namespace(value=0) %}

        {% for item_data in upgraded_items[:8] %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "ðŸ“º {% if item_data.item.item_type == 'Episode' -%}
              {{ item_data.item.series_name }} - {{ item_data.item.name }}
            {%- else -%}
              {{ item_data.item.name }}
            {%- endif %}",

          "value": "
            {%- if item_data.item.item_type == 'Episode' -%}
              S{{ '%02d'|format(item_data.item.season_number or 0) }}E{{ '%02d'|format(item_data.item.episode_number or 0) }}
            {%- endif -%}

            {%- if item_data.changes and item_data.changes|length > 0 -%}
              \n**Upgrades:**
              {%- for change in item_data.changes[:2] %}
                \nâ€¢ {{ change.old_value or 'Inconnu' }} â†’ **{{ change.new_value or 'Inconnu' }}**
              {%- endfor -%}
              {%- if item_data.changes|length > 2 %} (+{{ item_data.changes|length - 2 }} de plus){% endif -%}
            {%- endif -%}

            {%- if item_data.item.video_height -%}
              \nðŸ“ Maintenant : {{ item_data.item.video_height }}p
              {%- if item_data.item.video_range and item_data.item.video_range != 'SDR' %} {{ item_data.item.video_range }}{% endif -%}
            {%- endif -%}

            {#
              Notes TV en ligne
              ------------------
            #}
            {%- set rating_parts = [] -%}
            {%- if item_data.item.tvdb and item_data.item.tvdb.rating -%}
              {%- set _ = rating_parts.append('TVDb: ' ~ item_data.item.tvdb.rating) -%}
            {%- endif -%}
            {%- if item_data.item.omdb and item_data.item.omdb.imdb_rating and item_data.item.omdb.imdb_rating != 'N/A' -%}
              {%- set _ = rating_parts.append('IMDb: ' ~ item_data.item.omdb.imdb_rating) -%}
            {%- endif -%}
            {%- if rating_parts|length > 0 -%}
              \nâ­ {{ rating_parts | join(' â€¢ ') }}
            {%- endif %}",

          "inline": false
        }
        {% endfor %}

        {% if upgraded_items|length > 8 %}
          {% if field_count.value > 0 %},{% endif %}
        {
          "name": "âž• Mises Ã  Jour TV SupplÃ©mentaires",
          "value": "Et {{ upgraded_items|length - 8 }} Ã©lÃ©ments TV mis Ã  jour de plus...",
          "inline": false
        }
        {% endif %}
      ]
    }

    {% elif category == 'music' %}
    {
      "title": "â¬†ï¸ Musique Mise Ã  Jour ({{ total_items }})",
      "description": "La musique suivante a Ã©tÃ© mise Ã  jour dans Jellyfin :",
      "color": {{ color }},

      "fields": [
        {% set field_count = namespace(value=0) %}

        {% for item_data in upgraded_items[:10] %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "ðŸŽµ {{ item_data.item.name }}",

          "value": "
            {%- if item_data.item.album %}Album: {{ item_data.item.album }}\n{% endif -%}
            {%- if item_data.item.artists %}Artist: {{ item_data.item.artists | join(', ') }}\n{% endif -%}

            {%- if item_data.changes and item_data.changes|length > 0 -%}
              **Mises Ã  jour :**
              {%- for change in item_data.changes[:1] %}
                \nâ€¢ {{ change.old_value or 'Inconnu' }} â†’ **{{ change.new_value or 'Inconnu' }}**
              {%- endfor -%}
            {%- endif -%}

            {%- if item_data.item.audio_codec -%}
              \nðŸ”Š Maintenant : {{ item_data.item.audio_codec|upper }}
              {%- if item_data.item.audio_bitrate %} @ {{ (item_data.item.audio_bitrate / 1000)|round(0) }} kbps{% endif -%}
            {%- endif %}",

          "inline": true
        }
        {% endfor %}

        {% if upgraded_items|length > 10 %}
          {% if field_count.value > 0 %},{% endif %}
        {
          "name": "âž• Mises Ã  Jour Musicales SupplÃ©mentaires",
          "value": "Et {{ upgraded_items|length - 10 }} Ã©lÃ©ments musicaux mis Ã  jour de plus...",
          "inline": false
        }
        {% endif %}
      ]
    }

    {% else %}
    {
      "title": "â¬†ï¸ Ã‰lÃ©ments Mis Ã  Jour ({{ total_items }})",
      "description": "Les Ã©lÃ©ments suivants ont Ã©tÃ© mis Ã  jour dans Jellyfin :",
      "color": {{ color }},

      "fields": [
        {% set field_count = namespace(value=0) %}

        {% for item_data in upgraded_items[:15] %}
          {% if field_count.value > 0 %},{% endif %}
          {% set field_count.value = field_count.value + 1 %}
        {
          "name": "{{ item_data.item.item_type }}: {{ item_data.item.name }}",

          "value": "
            {%- if item_data.changes and item_data.changes|length > 0 -%}
              Mis Ã  jour : {{ item_data.changes[0].old_value or 'Inconnu' }} â†’ **{{ item_data.changes[0].new_value or 'Inconnu' }}**
            {%- else -%}
              Ã‰lÃ©ment mis Ã  jour
            {%- endif %}",

          "inline": true
        }
        {% endfor %}

        {% if upgraded_items|length > 15 %}
          {% if field_count.value > 0 %},{% endif %}
        {
          "name": "âž• Mises Ã  Jour SupplÃ©mentaires",
          "value": "Et {{ upgraded_items|length - 15 }} Ã©lÃ©ments mis Ã  jour de plus...",
          "inline": false
        }
        {% endif %}
      ]
    }
    {% endif %}
    ,

    "footer": {
      "text": "Jellyfin
        {%- if upgraded_items[0].item.server_name %} â€¢ {{ upgraded_items[0].item.server_name }}{% endif %}
        {%- set has_omdb = upgraded_items | selectattr('item.omdb') | list | length > 0 -%}
        {%- set has_tvdb = upgraded_items | selectattr('item.tvdb') | list | length > 0 -%}
        {%- set has_tmdb = upgraded_items | selectattr('item.tmdb') | list | length > 0 -%}
        {%- if has_omdb %} â€¢ IMDb via OMDb{% endif -%}
        {%- if has_tvdb %} â€¢ TheTVDB{% endif -%}
        {%- if has_tmdb %} â€¢ TMDb{% endif %}",
      "icon_url": {{ (jellyfin_url ~ "/web/favicon.ico") | tojson }}
    },

    "timestamp": {{ timestamp | tojson }}
  ]
}
